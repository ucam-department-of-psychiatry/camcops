
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.cc_modules.cc_task &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.cc_modules.cc_task</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/cc_modules/cc_task.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">Core task export methods:</span>

<span class="sd">------  -----------------------------------------------------------------------</span>
<span class="sd">Format  Comment</span>
<span class="sd">------  -----------------------------------------------------------------------</span>
<span class="sd">HTML    The task in a user-friendly format</span>
<span class="sd">PDF     Essentially the HTML output</span>
<span class="sd">XML     Centres on the task with its subdata integrated</span>
<span class="sd">TSV     Tab-separated value format</span>
<span class="sd">SQL     As part of an SQL or SQLite download</span>
<span class="sd">------  -----------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">statistics</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span>
                    <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.classes</span> <span class="k">import</span> <span class="n">classproperty</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.datetimefunc</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">convert_datetime_to_utc</span><span class="p">,</span>
    <span class="n">format_datetime</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">BraceStyleAdapter</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.orm_query</span> <span class="k">import</span> <span class="n">get_rows_fieldnames_from_query</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.orm_inspect</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">gen_columns</span><span class="p">,</span>
    <span class="n">gen_orm_classes_from_base</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.schema</span> <span class="k">import</span> <span class="n">is_sqlatype_string</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.sqlfunc</span> <span class="k">import</span> <span class="n">extract_month</span><span class="p">,</span> <span class="n">extract_year</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.stringfunc</span> <span class="k">import</span> <span class="n">mangle_unicode_to_ascii</span>
<span class="kn">import</span> <span class="nn">hl7</span>
<span class="kn">from</span> <span class="nn">pendulum</span> <span class="k">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateTime</span> <span class="k">as</span> <span class="n">Pendulum</span>
<span class="kn">from</span> <span class="nn">pyramid.renderers</span> <span class="k">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">semantic_version</span> <span class="k">import</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declared_attr</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.relationships</span> <span class="k">import</span> <span class="n">RelationshipProperty</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="p">(</span><span class="n">and_</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">literal</span><span class="p">,</span> <span class="n">not_</span><span class="p">,</span>
                                       <span class="n">select</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.schema</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.sqltypes</span> <span class="k">import</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">from</span> <span class="nn">.cc_anon</span> <span class="k">import</span> <span class="n">get_cris_dd_rows_from_fieldspecs</span>
<span class="kn">from</span> <span class="nn">.cc_audit</span> <span class="k">import</span> <span class="n">audit</span>
<span class="kn">from</span> <span class="nn">.cc_blob</span> <span class="k">import</span> <span class="n">Blob</span><span class="p">,</span> <span class="n">get_blob_img_html</span>
<span class="kn">from</span> <span class="nn">.cc_cache</span> <span class="k">import</span> <span class="n">cache_region_static</span><span class="p">,</span> <span class="n">fkg</span>
<span class="kn">from</span> <span class="nn">.cc_constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CRIS_CLUSTER_KEY_FIELDSPEC</span><span class="p">,</span>
    <span class="n">CRIS_PATIENT_COMMENT_PREFIX</span><span class="p">,</span>
    <span class="n">CRIS_SUMMARY_COMMENT_PREFIX</span><span class="p">,</span>
    <span class="n">CRIS_TABLENAME_PREFIX</span><span class="p">,</span>
    <span class="n">CSS_PAGED_MEDIA</span><span class="p">,</span>
    <span class="n">DateFormat</span><span class="p">,</span>
    <span class="n">ERA_NOW</span><span class="p">,</span>
    <span class="n">INVALID_VALUE</span><span class="p">,</span>
    <span class="n">TSV_PATIENT_FIELD_PREFIX</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_ctvinfo</span> <span class="k">import</span> <span class="n">CtvInfo</span>
<span class="kn">from</span> <span class="nn">.cc_db</span> <span class="k">import</span> <span class="n">GenericTabletRecordMixin</span>
<span class="kn">from</span> <span class="nn">.cc_filename</span> <span class="k">import</span> <span class="n">get_export_filename</span>
<span class="kn">from</span> <span class="nn">.cc_hl7core</span> <span class="k">import</span> <span class="n">make_obr_segment</span><span class="p">,</span> <span class="n">make_obx_segment</span>
<span class="kn">from</span> <span class="nn">.cc_html</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_present_absent_none</span><span class="p">,</span>
    <span class="n">get_true_false_none</span><span class="p">,</span>
    <span class="n">get_yes_no</span><span class="p">,</span>
    <span class="n">get_yes_no_none</span><span class="p">,</span>
    <span class="n">tr</span><span class="p">,</span>
    <span class="n">tr_qa</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_patient</span> <span class="k">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">.cc_patientidnum</span> <span class="k">import</span> <span class="n">PatientIdNum</span>
<span class="kn">from</span> <span class="nn">.cc_pdf</span> <span class="k">import</span> <span class="n">pdf_from_html</span>
<span class="kn">from</span> <span class="nn">.cc_pyramid</span> <span class="k">import</span> <span class="n">ViewArg</span>
<span class="kn">from</span> <span class="nn">.cc_recipdef</span> <span class="k">import</span> <span class="n">RecipientDefinition</span>
<span class="kn">from</span> <span class="nn">.cc_report</span> <span class="k">import</span> <span class="n">Report</span><span class="p">,</span> <span class="n">PlainReportType</span>
<span class="kn">from</span> <span class="nn">.cc_request</span> <span class="k">import</span> <span class="n">CamcopsRequest</span>
<span class="kn">from</span> <span class="nn">.cc_specialnote</span> <span class="k">import</span> <span class="n">SpecialNote</span>
<span class="kn">from</span> <span class="nn">.cc_sqla_coltypes</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CamcopsColumn</span><span class="p">,</span>
    <span class="n">PendulumDateTimeAsIsoTextColType</span><span class="p">,</span>
    <span class="n">gen_ancillary_relationships</span><span class="p">,</span>
    <span class="n">get_column_attr_names</span><span class="p">,</span>
    <span class="n">get_camcops_blob_column_attr_names</span><span class="p">,</span>
    <span class="n">permitted_value_failure_msgs</span><span class="p">,</span>
    <span class="n">permitted_values_ok</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_sqlalchemy</span> <span class="k">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">.cc_summaryelement</span> <span class="k">import</span> <span class="n">ExtraSummaryTable</span><span class="p">,</span> <span class="n">SummaryElement</span>
<span class="kn">from</span> <span class="nn">.cc_trackerhelpers</span> <span class="k">import</span> <span class="n">TrackerInfo</span>
<span class="kn">from</span> <span class="nn">.cc_tsv</span> <span class="k">import</span> <span class="n">TsvPage</span>
<span class="kn">from</span> <span class="nn">.cc_version</span> <span class="k">import</span> <span class="n">MINIMUM_TABLET_VERSION</span>
<span class="kn">from</span> <span class="nn">.cc_unittest</span> <span class="k">import</span> <span class="n">DemoDatabaseTestCase</span>
<span class="kn">from</span> <span class="nn">.cc_xml</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_xml_document</span><span class="p">,</span>
    <span class="n">XML_COMMENT_ANCILLARY</span><span class="p">,</span>
    <span class="n">XML_COMMENT_ANONYMOUS</span><span class="p">,</span>
    <span class="n">XML_COMMENT_BLOBS</span><span class="p">,</span>
    <span class="n">XML_COMMENT_CALCULATED</span><span class="p">,</span>
    <span class="n">XML_COMMENT_PATIENT</span><span class="p">,</span>
    <span class="n">XML_COMMENT_SPECIAL_NOTES</span><span class="p">,</span>
    <span class="n">XmlElement</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>

<span class="n">ANCILLARY_FWD_REF</span> <span class="o">=</span> <span class="s2">&quot;Ancillary&quot;</span>
<span class="n">TASK_FWD_REF</span> <span class="o">=</span> <span class="s2">&quot;Task&quot;</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Patient mixin</span>
<span class="c1"># =============================================================================</span>

<span class="k">class</span> <span class="nc">TaskHasPatientMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># http://docs.sqlalchemy.org/en/latest/orm/extensions/declarative/mixins.html#using-advanced-relationship-arguments-e-g-primaryjoin-etc  # noqa</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">patient_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span>
            <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Foreign key to patient.id (for this device/era)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">patient</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RelationshipProperty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">relationship</span><span class="p">(</span>
            <span class="s2">&quot;Patient&quot;</span><span class="p">,</span>
            <span class="n">primaryjoin</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;and_(&quot;</span>
                <span class="s2">&quot; remote(Patient.id) == foreign(</span><span class="si">{task}</span><span class="s2">.patient_id), &quot;</span>
                <span class="s2">&quot; remote(Patient._device_id) == foreign(</span><span class="si">{task}</span><span class="s2">._device_id), &quot;</span>
                <span class="s2">&quot; remote(Patient._era) == foreign(</span><span class="si">{task}</span><span class="s2">._era), &quot;</span>
                <span class="s2">&quot; remote(Patient._current) == True &quot;</span>
                <span class="s2">&quot;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="c1"># EMPIRICALLY: SLOWER OVERALL WITH THIS # lazy=&quot;joined&quot;</span>
        <span class="p">)</span>
        <span class="c1"># NOTE: this retrieves the most recent (i.e. the current) information</span>
        <span class="c1"># on that patient. Consequently, task version history doesn&#39;t show the</span>
        <span class="c1"># history of patient edits. This is consistent with our relationship</span>
        <span class="c1"># strategy throughout for the web front-end viewer.</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_patient</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Clinician mixin</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="TaskHasClinicianMixin"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.TaskHasClinicianMixin">[docs]</a><span class="k">class</span> <span class="nc">TaskHasClinicianMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin to add clinician columns and override clinician-related methods.</span>
<span class="sd">    Must be to the LEFT of Task in the class&#39;s base class list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_specialty</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;clinician_specialty&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">exempt_from_anonymisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s specialty &quot;</span>
                    <span class="s2">&quot;(e.g. Liaison Psychiatry)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;clinician_name&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">exempt_from_anonymisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s name (e.g. Dr X)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_professional_registration</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;clinician_professional_registration&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s professional registration (e.g. &quot;</span>
                    <span class="s2">&quot;GMC# 12345)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_post</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;clinician_post&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">exempt_from_anonymisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s post (e.g. Consultant)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_service</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;clinician_service&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">exempt_from_anonymisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s service (e.g. Liaison Psychiatry &quot;</span>
                    <span class="s2">&quot;Service)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">clinician_contact_details</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;clinician_contact_details&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">exempt_from_anonymisation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(CLINICIAN) Clinician&#39;s contact details (e.g. bleep, &quot;</span>
                    <span class="s2">&quot;extension)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># For field order, see also:</span>
    <span class="c1"># https://stackoverflow.com/questions/3923910/sqlalchemy-move-mixin-columns-to-end  # noqa</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_clinician</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_clinician_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clinician_name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Respondent mixin</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="TaskHasRespondentMixin"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.TaskHasRespondentMixin">[docs]</a><span class="k">class</span> <span class="nc">TaskHasRespondentMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixin to add respondent columns and override respondent-related methods.</span>
<span class="sd">    Must be to the LEFT of Task in the class&#39;s base class list.</span>

<span class="sd">    If you don&#39;t use declared_attr, the &quot;comment&quot; property doesn&#39;t work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">respondent_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span>
            <span class="s2">&quot;respondent_name&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">identifies_patient</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(RESPONDENT) Respondent&#39;s name&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">respondent_relationship</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;respondent_relationship&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(RESPONDENT) Respondent&#39;s relationship to patient&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_respondent</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">is_respondent_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">respondent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">respondent_relationship</span><span class="p">])</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Task base class</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">GenericTabletRecordMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for all tasks.</span>

<span class="sd">    - Column definitions:</span>

<span class="sd">        Use CamcopsColumn, not Column, if you have fields that need to define</span>
<span class="sd">        permitted values, mark them as BLOB-referencing fields, or do other</span>
<span class="sd">        CamCOPS-specific things.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__abstract__</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">__mapper_args__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;concrete&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># PART 0: COLUMNS COMMON TO ALL TASKS</span>
    <span class="c1"># =========================================================================</span>

    <span class="c1"># Columns</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">when_created</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;when_created&quot;</span><span class="p">,</span> <span class="n">PendulumDateTimeAsIsoTextColType</span><span class="p">,</span>
            <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Date/time this task instance was created (ISO 8601)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">when_firstexit</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;when_firstexit&quot;</span><span class="p">,</span> <span class="n">PendulumDateTimeAsIsoTextColType</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Date/time of the first exit from this task &quot;</span>
                    <span class="s2">&quot;(ISO 8601)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">firstexit_is_finish</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;firstexit_is_finish&quot;</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Was the first exit from the task because it was &quot;</span>
                    <span class="s2">&quot;finished (1)?&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">firstexit_is_abort</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;firstexit_is_abort&quot;</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Was the first exit from this task because it was &quot;</span>
                    <span class="s2">&quot;aborted (1)?&quot;</span>
        <span class="p">)</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">editing_time_s</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Column</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
            <span class="s2">&quot;editing_time_s&quot;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(TASK) Time spent editing (s)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Relationships</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">special_notes</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RelationshipProperty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">relationship</span><span class="p">(</span>
            <span class="n">SpecialNote</span><span class="p">,</span>
            <span class="n">primaryjoin</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;and_(&quot;</span>
                <span class="s2">&quot; remote(SpecialNote.basetable) == literal(</span><span class="si">{repr_task_tablename}</span><span class="s2">), &quot;</span>  <span class="c1"># noqa</span>
                <span class="s2">&quot; remote(SpecialNote.task_id) == foreign(</span><span class="si">{task}</span><span class="s2">.id), &quot;</span>
                <span class="s2">&quot; remote(SpecialNote.device_id) == foreign(</span><span class="si">{task}</span><span class="s2">._device_id), &quot;</span>  <span class="c1"># noqa</span>
                <span class="s2">&quot; remote(SpecialNote.era) == foreign(</span><span class="si">{task}</span><span class="s2">._era) &quot;</span>
                <span class="s2">&quot;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">repr_task_tablename</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;SpecialNote.note_at&quot;</span><span class="p">,</span>
            <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># for now!</span>
        <span class="p">)</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># PART 1: THINGS THAT DERIVED CLASSES MAY CARE ABOUT</span>
    <span class="c1"># =========================================================================</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Attributes that must be provided</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: str  # also the SQLAlchemy table name</span>
    <span class="n">shortname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: str</span>
    <span class="n">longname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: str</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Attributes that can be overridden</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">extrastring_taskname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: str  # if None, tablename is used instead  # noqa</span>
    <span class="n">provides_trackers</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_landscape_for_pdf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dependent_classes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Methods always overridden by the actual task</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.is_complete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is the task instance complete?</span>
<span class="sd">        Must be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Task.is_complete must be overridden&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_task_html"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_task_html">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        HTML for the main task content.</span>
<span class="sd">        Overridden by derived classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;No get_task_html() HTML generator for this task class!&quot;</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Implement if you provide trackers</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_trackers"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_trackers">[docs]</a>    <span class="k">def</span> <span class="nf">get_trackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TrackerInfo</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tasks that provide quantitative information for tracking over time</span>
<span class="sd">        should override this and return a list of TrackerInfo, one per tracker.</span>

<span class="sd">        The information is read by get_all_plots_for_one_task_html() in</span>
<span class="sd">        cc_tracker.py -- q.v.</span>

<span class="sd">        Time information will be retrieved using the get_creation_datetime()</span>
<span class="sd">        function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Override to provide clinical text</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
<div class="viewcode-block" id="Task.get_clinical_text"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_clinical_text">[docs]</a>    <span class="k">def</span> <span class="nf">get_clinical_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">CtvInfo</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Tasks that provide clinical text information should override this</span>
<span class="sd">        to provide a list of dictionaries.</span>

<span class="sd">        Return None (default) for a task that doesn&#39;t provide clinical text,</span>
<span class="sd">        or [] for one with no information, or a list of CtvInfo objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Override some of these if you provide summaries</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodMayBeStatic,PyUnusedLocal</span>
<div class="viewcode-block" id="Task.get_extra_summary_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_extra_summary_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_extra_summary_tables</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ExtraSummaryTable</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override if you wish to create extra summary tables, not just add</span>
<span class="sd">        summary columns to task/ancillary tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># PART 2: INTERNALS</span>
    <span class="c1"># =========================================================================</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Way to fetch all task types</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.gen_all_subclasses"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.gen_all_subclasses">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gen_all_subclasses</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TASK_FWD_REF</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We require that actual tasks are subclasses of both Task and Base</span>

<span class="sd">        ... so we can (a) inherit from Task to make a base class for actual</span>
<span class="sd">        tasks, as with PCL, HADS, HoNOS, etc.; and (b) not have those</span>
<span class="sd">        intermediate classes appear in the task list. Since all actual classes</span>
<span class="sd">        must be SQLAlchemy ORM objects inheriting from Base, that common</span>
<span class="sd">        inheritance is an excellent way to define them.</span>

<span class="sd">        ... CHANGED: things now inherit from Base/Task without necessarily</span>
<span class="sd">        being actual tasks; we discriminate using __abstract__ and/or</span>
<span class="sd">        __tablename__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gen_orm_classes_from_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="nd">@cache_region_static</span><span class="o">.</span><span class="n">cache_on_arguments</span><span class="p">(</span><span class="n">function_key_generator</span><span class="o">=</span><span class="n">fkg</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_subclasses_by_tablename</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TASK_FWD_REF</span><span class="p">]]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">gen_all_subclasses</span><span class="p">())</span>
        <span class="n">classes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classes</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@cache_region_static</span><span class="o">.</span><span class="n">cache_on_arguments</span><span class="p">(</span><span class="n">function_key_generator</span><span class="o">=</span><span class="n">fkg</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_subclasses_by_shortname</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TASK_FWD_REF</span><span class="p">]]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">gen_all_subclasses</span><span class="p">())</span>
        <span class="n">classes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">shortname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classes</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@cache_region_static</span><span class="o">.</span><span class="n">cache_on_arguments</span><span class="p">(</span><span class="n">function_key_generator</span><span class="o">=</span><span class="n">fkg</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_subclasses_by_longname</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">TASK_FWD_REF</span><span class="p">]]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">gen_all_subclasses</span><span class="p">())</span>
        <span class="n">classes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">longname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classes</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Methods that may be overridden by mixins</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_patient</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        May be overridden by TaskHasPatientMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Antonym for has_patient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">has_patient</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_clinician</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        May be overridden by TaskHasClinicianMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">has_respondent</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        May be overridden by TaskHasRespondentMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Other classmethods</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">tablename</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">minimum_client_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Version</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MINIMUM_TABLET_VERSION</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_tables_with_min_client_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Version</span><span class="p">]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">minimum_client_version</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>  <span class="c1"># type: Dict[str, Version]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rel_cls</span> <span class="ow">in</span> <span class="n">gen_ancillary_relationships</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">rel_cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># More on fields</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_fieldnames</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">get_column_attr_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

<div class="viewcode-block" id="Task.field_contents_valid"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.field_contents_valid">[docs]</a>    <span class="k">def</span> <span class="nf">field_contents_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks field contents validity against fieldspecs.</span>
<span class="sd">        This is a high-speed function that doesn&#39;t bother with explanations,</span>
<span class="sd">        since we use it for lots of task is_complete() calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">permitted_values_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.field_contents_invalid_because"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.field_contents_invalid_because">[docs]</a>    <span class="k">def</span> <span class="nf">field_contents_invalid_because</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Explains why contents are invalid.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">permitted_value_failure_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_blob_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">get_camcops_blob_column_attr_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Server field calculations</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">get_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>

<div class="viewcode-block" id="Task.is_preserved"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_preserved">[docs]</a>    <span class="k">def</span> <span class="nf">is_preserved</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the task preserved and erased from the tablet?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_era</span> <span class="o">!=</span> <span class="n">ERA_NOW</span></div>

<div class="viewcode-block" id="Task.was_forcibly_preserved"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.was_forcibly_preserved">[docs]</a>    <span class="k">def</span> <span class="nf">was_forcibly_preserved</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Was it forcibly preserved?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forcibly_preserved</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_preserved</span><span class="p">()</span></div>

<div class="viewcode-block" id="Task.get_creation_datetime"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_creation_datetime">[docs]</a>    <span class="k">def</span> <span class="nf">get_creation_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creation datetime, or None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_created</span></div>

<div class="viewcode-block" id="Task.get_creation_datetime_utc"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_creation_datetime_utc">[docs]</a>    <span class="k">def</span> <span class="nf">get_creation_datetime_utc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creation datetime in UTC, or None.&quot;&quot;&quot;</span>
        <span class="n">localtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_creation_datetime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">localtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">convert_datetime_to_utc</span><span class="p">(</span><span class="n">localtime</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_seconds_from_creation_to_first_finish"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_seconds_from_creation_to_first_finish">[docs]</a>    <span class="k">def</span> <span class="nf">get_seconds_from_creation_to_first_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Time in seconds from creation time to first finish (i.e. first exit</span>
<span class="sd">        if the first exit was a finish rather than an abort), or None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstexit_is_finish</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_creation_datetime</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_firstexit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">return</span> <span class="n">diff</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">get_adding_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adding_user_id</span>

    <span class="k">def</span> <span class="nf">get_adding_user_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adding_user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adding_user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_removing_user_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_removing_user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_removing_user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_preserving_user_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preserving_user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preserving_user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_manually_erasing_user_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manually_erasing_user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manually_erasing_user</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Summary tables</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">standard_task_summary_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SummaryElement</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">SummaryElement</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;is_complete&quot;</span><span class="p">,</span>
                <span class="n">coltype</span><span class="o">=</span><span class="n">Boolean</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span><span class="p">(),</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(GENERIC) Task complete?&quot;</span>
            <span class="p">),</span>
            <span class="n">SummaryElement</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;seconds_from_creation_to_first_finish&quot;</span><span class="p">,</span>
                <span class="n">coltype</span><span class="o">=</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_seconds_from_creation_to_first_finish</span><span class="p">(),</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;(GENERIC) Time (in seconds) from record creation to &quot;</span>
                        <span class="s2">&quot;first exit, if that was a finish not an abort&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Testing</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.dump"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dump to log.&quot;&quot;&quot;</span>
        <span class="n">line_equals</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">79</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line_equals</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fieldnames</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{f}</span><span class="s2">: </span><span class="si">{v!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_equals</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Special notes</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.apply_special_note"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.apply_special_note">[docs]</a>    <span class="k">def</span> <span class="nf">apply_special_note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                           <span class="n">note</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">from_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually applies a special note to a task.</span>

<span class="sd">        Applies it to all predecessor/successor versions as well.</span>
<span class="sd">        WRITES TO DATABASE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="n">SpecialNote</span><span class="p">()</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">basetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_id</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">era</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_era</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">note_at</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">now</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user_id</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Special note applied manually&quot;</span><span class="p">,</span> <span class="n">from_console</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_from_hl7_message_log</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">from_console</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Clinician</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
<div class="viewcode-block" id="Task.get_clinician_name"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_clinician_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_clinician_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the clinician&#39;s name.</span>
<span class="sd">        May be overridden by TaskHasClinicianMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Respondent</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
<div class="viewcode-block" id="Task.is_respondent_complete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_respondent_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_respondent_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        May be overridden by TaskHasRespondentMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># About the associated patient</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">patient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Patient</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden by TaskHasPatientMixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Task.is_female"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_female">[docs]</a>    <span class="k">def</span> <span class="nf">is_female</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the patient female?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">is_female</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Task.is_male"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_male">[docs]</a>    <span class="k">def</span> <span class="nf">is_male</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the patient male?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">is_male</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Task.get_patient_server_pk"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_server_pk">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_server_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the server PK of the patient, or None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_pk</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Task.get_patient_forename"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_forename">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_forename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the patient&#39;s forename, in upper case, or &quot;&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_forename</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Task.get_patient_surname"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_surname">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_surname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the patient&#39;s surname, in upper case, or &quot;&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_surname</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Task.get_patient_dob"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_dob">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_dob</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Date</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the patient&#39;s DOB, or None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_dob</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Task.get_patient_dob_first11chars"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_dob_first11chars">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_dob_first11chars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;For example: &#39;29 Dec 1999&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">dob_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_dob_str</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dob_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">dob_str</span><span class="p">[:</span><span class="mi">11</span><span class="p">]</span></div>

<div class="viewcode-block" id="Task.get_patient_sex"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_sex">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_sex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the patient&#39;s sex, or &quot;&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_sex</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="Task.get_patient_address"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_address">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the patient&#39;s address, or &quot;&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_address</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">get_patient_idnum_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PatientIdNum</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_idnum_objects</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="p">[]</span>

<div class="viewcode-block" id="Task.get_patient_idnum_object"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_idnum_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_idnum_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">which_idnum</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PatientIdNum</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the patient&#39;s ID number, or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_idnum_object</span><span class="p">(</span><span class="n">which_idnum</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_patient_idnum_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which_idnum</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">idobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patient_idnum_object</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="n">which_idnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idobj</span><span class="o">.</span><span class="n">idnum_value</span> <span class="k">if</span> <span class="n">idobj</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="Task.get_patient_hl7_pid_segment"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_patient_hl7_pid_segment">[docs]</a>    <span class="k">def</span> <span class="nf">get_patient_hl7_pid_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                    <span class="n">recipient_def</span><span class="p">:</span> <span class="n">RecipientDefinition</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get patient HL7 PID segment, or &quot;&quot;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_hl7_pid_segment</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">recipient_def</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># HL7</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_hl7_data_segments"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_hl7_data_segments">[docs]</a>    <span class="k">def</span> <span class="nf">get_hl7_data_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                              <span class="n">recipient_def</span><span class="p">:</span> <span class="n">RecipientDefinition</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of HL7 data segments.</span>

<span class="sd">        These will be:</span>
<span class="sd">            OBR segment</span>
<span class="sd">            OBX segment</span>
<span class="sd">            any extra ones offered by the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obr_segment</span> <span class="o">=</span> <span class="n">make_obr_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">obx_segment</span> <span class="o">=</span> <span class="n">make_obx_segment</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">task_format</span><span class="o">=</span><span class="n">recipient_def</span><span class="o">.</span><span class="n">task_format</span><span class="p">,</span>
            <span class="n">observation_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">),</span>
            <span class="n">observation_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_creation_datetime</span><span class="p">(),</span>
            <span class="n">responsible_observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clinician_name</span><span class="p">(),</span>
            <span class="n">xml_field_comments</span><span class="o">=</span><span class="n">recipient_def</span><span class="o">.</span><span class="n">xml_field_comments</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">obr_segment</span><span class="p">,</span>
            <span class="n">obx_segment</span>
        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hl7_extra_data_segments</span><span class="p">(</span><span class="n">recipient_def</span><span class="p">)</span></div>

    <span class="c1"># noinspection PyMethodMayBeStatic,PyUnusedLocal</span>
<div class="viewcode-block" id="Task.get_hl7_extra_data_segments"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_hl7_extra_data_segments">[docs]</a>    <span class="k">def</span> <span class="nf">get_hl7_extra_data_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient_def</span><span class="p">:</span> <span class="n">RecipientDefinition</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of any extra HL7 data segments.</span>

<span class="sd">        May be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Task.delete_from_hl7_message_log"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.delete_from_hl7_message_log">[docs]</a>    <span class="k">def</span> <span class="nf">delete_from_hl7_message_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                    <span class="n">from_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Erases the object from the HL7 message log (so it will be resent).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.cc_hl7</span> <span class="k">import</span> <span class="n">HL7Message</span>  <span class="c1"># delayed import</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">basetable</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">serverpk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">cancelled</span><span class="p">)</span> <span class="o">|</span>
                   <span class="n">HL7Message</span><span class="o">.</span><span class="n">cancelled</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">cancelled</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">cancelled_at_utc</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">)</span>
        <span class="c1"># ... this bit: ... AND (NOT cancelled OR cancelled IS NULL) ...:</span>
        <span class="c1"># https://stackoverflow.com/questions/37445041/sqlalchemy-how-to-filter-column-which-contains-both-null-and-integer-values  # noqa</span>
        <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span>
            <span class="s2">&quot;Task cancelled in outbound HL7 message log (may trigger &quot;</span>
            <span class="s2">&quot;resending)&quot;</span><span class="p">,</span>
            <span class="n">from_console</span>
        <span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Audit</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.audit"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.audit">[docs]</a>    <span class="k">def</span> <span class="nf">audit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">from_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Audits actions to this task.&quot;&quot;&quot;</span>
        <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
              <span class="n">details</span><span class="p">,</span>
              <span class="n">patient_server_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_patient_server_pk</span><span class="p">(),</span>
              <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
              <span class="n">server_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk</span><span class="p">,</span>
              <span class="n">from_console</span><span class="o">=</span><span class="n">from_console</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Erasure (wiping, leaving record as placeholder)</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.manually_erase"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.manually_erase">[docs]</a>    <span class="k">def</span> <span class="nf">manually_erase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually erases a task (including sub-tables).</span>
<span class="sd">        Also erases linked non-current records.</span>
<span class="sd">        This WIPES THE CONTENTS but LEAVES THE RECORD AS A PLACEHOLDER.</span>

<span class="sd">        Audits the erasure. Propagates erase through to the HL7 log, so those</span>
<span class="sd">        records will be re-sent. WRITES TO DATABASE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Erase ourself and any other in our &quot;family&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lineage</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">manually_erase_with_dependants</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="c1"># Audit and clear HL7 message log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Task details erased manually&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_from_hl7_message_log</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">is_erased</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manually_erased</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Complete deletion</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.delete_entirely"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.delete_entirely">[docs]</a>    <span class="k">def</span> <span class="nf">delete_entirely</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completely delete this task, its lineage, and its dependents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lineage</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">delete_with_dependants</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Task deleted&quot;</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Viewing the task in the list of tasks</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.is_live_on_tablet"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_live_on_tablet">[docs]</a>    <span class="k">def</span> <span class="nf">is_live_on_tablet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the instance live on a tablet?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Filtering tasks for the task list</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.gen_text_filter_columns"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.gen_text_filter_columns">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gen_text_filter_columns</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Column</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span>
                                                  <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields tuples of (attr_name, Column), for columns that are suitable</span>
<span class="sd">        for text filtering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">gen_columns</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attrname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>  <span class="c1"># system field</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sqlatype_string</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># TSV export for basic research dump</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_tsv_pages"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_tsv_pages">[docs]</a>    <span class="k">def</span> <span class="nf">get_tsv_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TsvPage</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns information used for the basic research dump in TSV format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Our core fields, plus summary information</span>
        <span class="n">main_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_core_tsv_page</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="c1"># 2. Patient details.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">:</span>
            <span class="n">main_page</span><span class="o">.</span><span class="n">add_or_set_columns_from_page</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_tsv_page</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
        <span class="n">tsv_pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">main_page</span><span class="p">]</span>
        <span class="c1"># 3. +/- Ancillary objects</span>
        <span class="k">for</span> <span class="n">ancillary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ancillary_instances</span><span class="p">():</span>  <span class="c1"># type: GenericTabletRecordMixin  # noqa</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">ancillary</span><span class="o">.</span><span class="n">_get_core_tsv_page</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">tsv_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="c1"># 4. +/- Extra summary tables</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_summary_tables</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
            <span class="n">tsv_pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">get_tsv_page</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tsv_pages</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Data structure for CRIS data dictionary</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_cris_dd_rows"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_cris_dd_rows">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_cris_dd_rows</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. todo:: fix get_cris_dd_rows</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">taskname</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">shortname</span>
        <span class="n">tablename</span> <span class="o">=</span> <span class="n">CRIS_TABLENAME_PREFIX</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># blank PK</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_cris_common_fieldspecs_values</span><span class="p">()</span>
        <span class="n">taskfieldspecs</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_cris_fieldspecs_values</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">common</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">get_cris_dd_rows_from_fieldspecs</span><span class="p">(</span><span class="n">taskname</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span>
                                                <span class="n">taskfieldspecs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">depclass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dependent_classes</span><span class="p">:</span>
            <span class="n">depinstance</span> <span class="o">=</span> <span class="n">depclass</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># blank PK</span>
            <span class="n">deptable</span> <span class="o">=</span> <span class="n">CRIS_TABLENAME_PREFIX</span> <span class="o">+</span> <span class="n">depinstance</span><span class="o">.</span><span class="n">tablename</span>
            <span class="n">depfieldspecs</span> <span class="o">=</span> <span class="n">depinstance</span><span class="o">.</span><span class="n">get_cris_fieldspecs_values</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">common</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="n">get_cris_dd_rows_from_fieldspecs</span><span class="p">(</span><span class="n">taskname</span><span class="p">,</span> <span class="n">deptable</span><span class="p">,</span>
                                                     <span class="n">depfieldspecs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Data export for CRIS and other anonymisation systems</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.make_cris_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.make_cris_tables">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_cris_tables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                         <span class="n">db</span><span class="p">:</span> <span class="s2">&quot;DatabaseSupporter&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. todo:: fix make_cris_tables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DO NOT CONFUSE pls.db and db. HERE WE ONLY USE db.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating CRIS staging tables for: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">shortname</span><span class="p">)</span>
        <span class="n">cc_db</span><span class="o">.</span><span class="n">set_db_to_utf8</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="n">task_table</span> <span class="o">=</span> <span class="n">CRIS_TABLENAME_PREFIX</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">created_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gen_all_current_tasks</span><span class="p">():</span>
            <span class="n">common_fsv</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_cris_common_fieldspecs_values</span><span class="p">()</span>
            <span class="n">task_fsv</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_cris_fieldspecs_values</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">common_fsv</span><span class="p">)</span>
            <span class="n">cc_db</span><span class="o">.</span><span class="n">add_sqltype_to_fieldspeclist_in_place</span><span class="p">(</span><span class="n">task_fsv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_tables</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">task_table</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">task_table</span><span class="p">,</span> <span class="n">task_fsv</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">created_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_table</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">insert_record_by_fieldspecs_with_values</span><span class="p">(</span><span class="n">task_table</span><span class="p">,</span> <span class="n">task_fsv</span><span class="p">)</span>
            <span class="c1"># Same for associated ancillary items</span>
            <span class="k">for</span> <span class="n">depclass</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dependent_classes</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_ancillary_items</span><span class="p">(</span><span class="n">depclass</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">item_table</span> <span class="o">=</span> <span class="n">CRIS_TABLENAME_PREFIX</span> <span class="o">+</span> <span class="n">it</span><span class="o">.</span><span class="n">tablename</span>
                    <span class="n">item_fsv</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">get_cris_fieldspecs_values</span><span class="p">(</span><span class="n">common_fsv</span><span class="p">)</span>
                    <span class="n">cc_db</span><span class="o">.</span><span class="n">add_sqltype_to_fieldspeclist_in_place</span><span class="p">(</span><span class="n">item_fsv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_tables</span><span class="p">:</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span><span class="n">item_table</span><span class="p">,</span> <span class="n">item_fsv</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">created_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">insert_record_by_fieldspecs_with_values</span><span class="p">(</span><span class="n">item_table</span><span class="p">,</span>
                                                               <span class="n">item_fsv</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_cris_common_fieldspecs_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FIELDSPECLIST_TYPE&quot;</span><span class="p">:</span>
        <span class="c1"># Store the task&#39;s PK in its own but all linked records</span>
        <span class="n">clusterpk_fs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">CRIS_CLUSTER_KEY_FIELDSPEC</span><span class="p">)</span>
        <span class="n">clusterpk_fs</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>
        <span class="n">fieldspecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">clusterpk_fs</span><span class="p">]</span>
        <span class="c1"># Store a subset of patient info in all linked records</span>
        <span class="n">patientfs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">FIELDSPECS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">patientfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cris_include&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">,</span> <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TSV_PATIENT_FIELD_PREFIX</span> <span class="o">+</span> <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRIS_PATIENT_COMMENT_PREFIX</span> <span class="o">+</span> <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">,</span>
                                                                     <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">fieldspecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fieldspecs</span>

    <span class="k">def</span> <span class="nf">get_cris_fieldspecs_values</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
            <span class="n">common_fsv</span><span class="p">:</span> <span class="s2">&quot;FIELDSPECLIST_TYPE&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FIELDSPECLIST_TYPE&quot;</span><span class="p">:</span>
        <span class="n">fieldspecs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_full_fieldspecs</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">fieldspecs</span><span class="p">:</span>
            <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summaries</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>  <span class="c1"># summaries include values</span>
        <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">summaries</span><span class="p">:</span>
            <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRIS_SUMMARY_COMMENT_PREFIX</span> <span class="o">+</span> <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">common_fsv</span> <span class="o">+</span>
            <span class="n">fieldspecs</span> <span class="o">+</span>
            <span class="n">summaries</span>
        <span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># XML view</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_xml"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_xml">[docs]</a>    <span class="k">def</span> <span class="nf">get_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                <span class="n">include_calculated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">include_blobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">include_patient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">indent_spaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                <span class="n">eol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">skip_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">include_comments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns XML UTF-8 document representing task.&quot;&quot;&quot;</span>
        <span class="n">skip_fields</span> <span class="o">=</span> <span class="n">skip_fields</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xml_root</span><span class="p">(</span><span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                                 <span class="n">include_calculated</span><span class="o">=</span><span class="n">include_calculated</span><span class="p">,</span>
                                 <span class="n">include_blobs</span><span class="o">=</span><span class="n">include_blobs</span><span class="p">,</span>
                                 <span class="n">include_patient</span><span class="o">=</span><span class="n">include_patient</span><span class="p">,</span>
                                 <span class="n">skip_fields</span><span class="o">=</span><span class="n">skip_fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_xml_document</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="n">indent_spaces</span><span class="o">=</span><span class="n">indent_spaces</span><span class="p">,</span>
            <span class="n">eol</span><span class="o">=</span><span class="n">eol</span><span class="p">,</span>
            <span class="n">include_comments</span><span class="o">=</span><span class="n">include_comments</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_xml_root"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_xml_root">[docs]</a>    <span class="k">def</span> <span class="nf">get_xml_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                     <span class="n">include_calculated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">include_blobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">include_patient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">include_ancillary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">skip_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XmlElement</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns XML tree. Return value is the root XmlElement.</span>

<span class="sd">        Override to include other tables, or to deal with BLOBs, if the default</span>
<span class="sd">        methods are insufficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skip_fields</span> <span class="o">=</span> <span class="n">skip_fields</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c1"># Core (inc. core BLOBs)</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xml_core_branches</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">include_calculated</span><span class="o">=</span><span class="n">include_calculated</span><span class="p">,</span>
            <span class="n">include_blobs</span><span class="o">=</span><span class="n">include_blobs</span><span class="p">,</span>
            <span class="n">include_patient</span><span class="o">=</span><span class="n">include_patient</span><span class="p">,</span>
            <span class="n">include_ancillary</span><span class="o">=</span><span class="n">include_ancillary</span><span class="p">,</span>
            <span class="n">skip_fields</span><span class="o">=</span><span class="n">skip_fields</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">XmlElement</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">branches</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span></div>

<div class="viewcode-block" id="Task.get_xml_core_branches"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_xml_core_branches">[docs]</a>    <span class="k">def</span> <span class="nf">get_xml_core_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
            <span class="n">include_calculated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">include_blobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">include_patient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">include_ancillary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">XmlElement</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of XmlElementTuple elements representing stored,</span>
<span class="sd">        calculated, patient, and/or BLOB fields, depending on the options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skip_fields</span> <span class="o">=</span> <span class="n">skip_fields</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c1"># Stored values +/- calculated values</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_branches</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">skip_attrs</span><span class="o">=</span><span class="n">skip_fields</span><span class="p">,</span>
            <span class="n">include_plain_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_blobs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_calculated</span><span class="o">=</span><span class="n">include_calculated</span>
        <span class="p">)</span>

        <span class="c1"># Special notes</span>
        <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_SPECIAL_NOTES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_notes</span><span class="p">:</span>
            <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">get_xml_root</span><span class="p">())</span>

        <span class="c1"># Patient details</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_ANONYMOUS</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">include_patient</span><span class="p">:</span>
            <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_PATIENT</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">:</span>
                <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_xml_root</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>

        <span class="c1"># BLOBs</span>
        <span class="k">if</span> <span class="n">include_blobs</span><span class="p">:</span>
            <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_BLOBS</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_branches</span><span class="p">(</span><span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                                               <span class="n">skip_attrs</span><span class="o">=</span><span class="n">skip_fields</span><span class="p">,</span>
                                               <span class="n">include_plain_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">include_blobs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">include_calculated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">sort_by_attr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Ancillary objects</span>
        <span class="k">if</span> <span class="n">include_ancillary</span><span class="p">:</span>
            <span class="n">item_collections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[XmlElement]</span>
            <span class="n">found_ancillary</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># We use a slightly more manual iteration process here so that</span>
            <span class="c1"># we iterate through individual ancillaries but clustered by their</span>
            <span class="c1"># name (e.g. if we have 50 trials and 5 groups, we do them in</span>
            <span class="c1"># collections).</span>
            <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">rel_prop</span><span class="p">,</span> <span class="n">rel_cls</span> <span class="ow">in</span> <span class="n">gen_ancillary_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_ancillary</span><span class="p">:</span>
                    <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_ANCILLARY</span><span class="p">)</span>
                    <span class="n">found_ancillary</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">itembranches</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[XmlElement]</span>
                <span class="k">if</span> <span class="n">rel_prop</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
                    <span class="n">ancillaries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>  <span class="c1"># type: List[GenericTabletRecordMixin]  # noqa</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ancillaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)]</span>  <span class="c1"># type: List[GenericTabletRecordMixin]  # noqa</span>
                <span class="k">for</span> <span class="n">ancillary</span> <span class="ow">in</span> <span class="n">ancillaries</span><span class="p">:</span>
                    <span class="n">itembranches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ancillary</span><span class="o">.</span><span class="n">_get_xml_root</span><span class="p">(</span>
                            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                            <span class="n">skip_attrs</span><span class="o">=</span><span class="n">skip_fields</span><span class="p">,</span>
                            <span class="n">include_plain_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">include_blobs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">include_calculated</span><span class="o">=</span><span class="n">include_calculated</span><span class="p">,</span>
                            <span class="n">sort_by_attr</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">itemcollection</span> <span class="o">=</span> <span class="n">XmlElement</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">itembranches</span><span class="p">)</span>
                <span class="n">item_collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itemcollection</span><span class="p">)</span>
            <span class="n">item_collections</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">+=</span> <span class="n">item_collections</span>

        <span class="c1"># Completely separate additional summary tables</span>
        <span class="k">if</span> <span class="n">include_calculated</span><span class="p">:</span>
            <span class="n">item_collections</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[XmlElement]</span>
            <span class="n">found_est</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_summary_tables</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_est</span> <span class="ow">and</span> <span class="n">est</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XML_COMMENT_CALCULATED</span><span class="p">)</span>
                    <span class="n">found_est</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">item_collections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">get_xml_element</span><span class="p">())</span>
            <span class="n">item_collections</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">+=</span> <span class="n">item_collections</span>

        <span class="k">return</span> <span class="n">branches</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># HTML view</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_html"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_html">[docs]</a>    <span class="k">def</span> <span class="nf">get_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">anonymise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns HTML representing task.&quot;&quot;&quot;</span>
        <span class="n">req</span><span class="o">.</span><span class="n">prepare_for_html_figures</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;task.mako&quot;</span><span class="p">,</span>
                      <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">,</span>
                           <span class="n">signature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">viewtype</span><span class="o">=</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">),</span>
                      <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># PDF view</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_pdf"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">anonymise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns PDF representing task.&quot;&quot;&quot;</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdf_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">)</span>  <span class="c1"># main content</span>
        <span class="k">if</span> <span class="n">CSS_PAGED_MEDIA</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pdf_from_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pdf_from_html</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span>
                <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="p">,</span>
                <span class="n">header_html</span><span class="o">=</span><span class="n">render</span><span class="p">(</span>
                    <span class="s2">&quot;wkhtmltopdf_header.mako&quot;</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">inner_text</span><span class="o">=</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;task_page_header.mako&quot;</span><span class="p">,</span>
                                           <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">),</span>
                                           <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">req</span>
                <span class="p">),</span>
                <span class="n">footer_html</span><span class="o">=</span><span class="n">render</span><span class="p">(</span>
                    <span class="s2">&quot;wkhtmltopdf_footer.mako&quot;</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">inner_text</span><span class="o">=</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;task_page_footer.mako&quot;</span><span class="p">,</span>
                                           <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
                                           <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">req</span>
                <span class="p">),</span>
                <span class="n">extra_wkhtmltopdf_options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Landscape&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_landscape_for_pdf</span>
                                    <span class="k">else</span> <span class="s2">&quot;Portrait&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_pdf_html"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_pdf_html">[docs]</a>    <span class="k">def</span> <span class="nf">get_pdf_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                     <span class="n">anonymise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets HTML used to make PDF (slightly different from plain HTML).&quot;&quot;&quot;</span>
        <span class="n">req</span><span class="o">.</span><span class="n">prepare_for_pdf_figures</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;task.mako&quot;</span><span class="p">,</span>
                      <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">,</span>
                           <span class="n">pdf_landscape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_landscape_for_pdf</span><span class="p">,</span>
                           <span class="n">signature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_clinician</span><span class="p">,</span>
                           <span class="n">viewtype</span><span class="o">=</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">),</span>
                      <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.suggested_pdf_filename"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.suggested_pdf_filename">[docs]</a>    <span class="k">def</span> <span class="nf">suggested_pdf_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Suggested filename for PDF.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
        <span class="k">return</span> <span class="n">get_export_filename</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">patient_spec_if_anonymous</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">patient_spec_if_anonymous</span><span class="p">,</span>
            <span class="n">patient_spec</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">patient_spec</span><span class="p">,</span>
            <span class="n">filename_spec</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">task_filename_spec</span><span class="p">,</span>
            <span class="n">task_format</span><span class="o">=</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
            <span class="n">is_anonymous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">,</span>
            <span class="n">surname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_surname</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">forename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_forename</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">dob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_dob</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_sex</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">idnum_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_idnum_objects</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa</span>
            <span class="n">creation_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_creation_datetime</span><span class="p">(),</span>
            <span class="n">basetable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">serverpk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Task.write_pdf_to_disk"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.write_pdf_to_disk">[docs]</a>    <span class="k">def</span> <span class="nf">write_pdf_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Writes PDF to disk, using filename.&quot;&quot;&quot;</span>
        <span class="n">pdffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">pdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pdf</span><span class="p">(</span><span class="n">req</span><span class="p">))</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Metadata for e.g. RiO</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_rio_metadata"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_rio_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_rio_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">which_idnum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">uploading_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">document_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by cc_hl7.send_to_filestore().</span>

<span class="sd">        From Servelec (Lee Meredith) to Rudolf Cardinal, 2014-12-04:</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            Batch Document Upload</span>

<span class="sd">            The RiO batch document upload function can be used to upload</span>
<span class="sd">            documents in bulk automatically.  RiO includes a Batch Upload</span>
<span class="sd">            windows service which monitors a designated folder for new files.</span>
<span class="sd">            Each file which is scanned must be placed in the designated folder</span>
<span class="sd">            along with a meta-data file which describes the document.  So</span>
<span class="sd">            essentially if a document had been scanned in and was called</span>
<span class="sd">            ThisIsANewReferralLetterForAPatient.pdf then there would also</span>
<span class="sd">            need to be a meta file in the same folder called</span>
<span class="sd">            ThisIsANewReferralLetterForAPatient.metadata.  The contents of</span>
<span class="sd">            the meta file would need to include the following:</span>

<span class="sd">                Field Order; Field Name; Description; Data Mandatory (Y/N);</span>
<span class="sd">                Format</span>

<span class="sd">                1; ClientID; RiO Client ID which identifies the patient in RiO</span>
<span class="sd">                against which the document will be uploaded.; Y; 15</span>
<span class="sd">                Alphanumeric Characters</span>

<span class="sd">                2; UserID; User ID of the uploaded document, this is any user</span>
<span class="sd">                defined within the RiO system and can be a single system user</span>
<span class="sd">                called AutomaticDocumentUploadUser for example.; Y; 10</span>
<span class="sd">                Alphanumeric Characters</span>

<span class="sd">                    [NB example longer than that!]</span>

<span class="sd">                3; DocumentType; The RiO defined document type eg: APT; Y; 80</span>
<span class="sd">                Alphanumeric Characters</span>

<span class="sd">                4; Title; The title of the document; N; 40 Alphanumeric</span>
<span class="sd">                Characters</span>

<span class="sd">                5; Description; The document description.; N; 500 Alphanumeric</span>
<span class="sd">                Characters</span>

<span class="sd">                6; Author; The author of the document; N; 80 Alphanumeric</span>
<span class="sd">                Characters</span>

<span class="sd">                7; DocumentDate; The date of the document; N; dd/MM/yyyy HH:mm</span>

<span class="sd">                8; FinalRevision; The revision values are 0 Draft or 1 Final,</span>
<span class="sd">                this is defaulted to 1 which is Final revision.; N; 0 or 1</span>

<span class="sd">            As an example, this is what would be needed in a meta file:</span>

<span class="sd">                1000001,TRUST1,APT,A title, A description of the</span>
<span class="sd">                    document, An author,01/12/2012 09:45,1</span>

<span class="sd">            (on one line)</span>

<span class="sd">        Clarification, from Lee Meredith to Rudolf Cardinal, 2015-02-18:</span>

<span class="sd">        - metadata files must be plain ASCII, not UTF-8</span>

<span class="sd">            - ... here and cc_hl7.send_to_filestore()</span>

<span class="sd">        - line terminator is &lt;CR&gt;</span>

<span class="sd">            - ... cc_hl7.send_to_filestore()</span>

<span class="sd">        - user name limit is 10 characters, despite incorrect example</span>

<span class="sd">            - ... RecipientDefinition.check_valid()</span>

<span class="sd">        - DocumentType is a code that maps to a human-readable document</span>
<span class="sd">          type; for example, &quot;APT&quot; might map to &quot;Appointment Letter&quot;. These</span>
<span class="sd">          mappings are specific to the local system. (We will probably want</span>
<span class="sd">          one that maps to &quot;Clinical Correspondence&quot; in the absence of</span>
<span class="sd">          anything more specific.)</span>

<span class="sd">        - RiO will delete the files after it&#39;s processed them.</span>

<span class="sd">        - Filenames should avoid spaces, but otherwise any other standard</span>
<span class="sd">          ASCII code is fine within filenames.</span>

<span class="sd">            - ... cc_hl7.send_to_filestore()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">get_idnum_value</span><span class="p">(</span><span class="n">which_idnum</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">client_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;CamCOPS_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortname</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longname</span>
        <span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clinician_name</span><span class="p">()</span>  <span class="c1"># may be blank</span>
        <span class="n">document_date</span> <span class="o">=</span> <span class="n">format_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">when_created</span><span class="p">,</span>
                                        <span class="n">DateFormat</span><span class="o">.</span><span class="n">RIO_EXPORT_UK</span><span class="p">)</span>
        <span class="c1"># This STRIPS the timezone information; i.e. it is in the local</span>
        <span class="c1"># timezone but doesn&#39;t tell you which timezone that is. (That&#39;s fine;</span>
        <span class="c1"># it should be local or users would be confused.)</span>
        <span class="n">final_revision</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_live_on_tablet</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">client_id</span><span class="p">,</span>
            <span class="n">uploading_user_id</span><span class="p">,</span>
            <span class="n">document_type</span><span class="p">,</span>
            <span class="n">title</span><span class="p">,</span>
            <span class="n">description</span><span class="p">,</span>
            <span class="n">author</span><span class="p">,</span>
            <span class="n">document_date</span><span class="p">,</span>
            <span class="n">final_revision</span>
        <span class="p">]</span>
        <span class="c1"># UTF-8 is NOT supported by RiO for metadata. So:</span>
        <span class="n">csv_line</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mangle_unicode_to_ascii</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item_list</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">csv_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># HTML elements used by tasks</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
<div class="viewcode-block" id="Task.get_standard_clinician_comments_block"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_standard_clinician_comments_block">[docs]</a>    <span class="k">def</span> <span class="nf">get_standard_clinician_comments_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                              <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                              <span class="n">comments</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML DIV for clinician&#39;s comments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;clinician_comments.mako&quot;</span><span class="p">,</span>
                      <span class="nb">dict</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="n">comments</span><span class="p">),</span>
                      <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_is_complete_td_pair"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_is_complete_td_pair">[docs]</a>    <span class="k">def</span> <span class="nf">get_is_complete_td_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML to indicate whether task is complete or not, and to make it</span>
<span class="sd">        very obvious visually when it isn&#39;t.&quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;&lt;td&gt;Completed?&lt;/td&gt;</span><span class="si">{}</span><span class="s2">&lt;b&gt;</span><span class="si">{}</span><span class="s2">&lt;/b&gt;&lt;/td&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;&lt;td&gt;&quot;</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="s2">&quot;&quot;&quot;&lt;td class=&quot;incomplete&quot;&gt;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">get_yes_no</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_is_complete_tr"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_is_complete_tr">[docs]</a>    <span class="k">def</span> <span class="nf">get_is_complete_tr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row to indicate whether task is complete or not, and to</span>
<span class="sd">        make it very obvious visually when it isn&#39;t.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;tr&gt;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_is_complete_td_pair</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/tr&gt;&quot;</span></div>

<div class="viewcode-block" id="Task.get_twocol_val_row"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_val_row">[docs]</a>    <span class="k">def</span> <span class="nf">get_twocol_val_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, without web-safing of value.&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="k">return</span> <span class="n">tr_qa</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.get_twocol_string_row"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_string_row">[docs]</a>    <span class="k">def</span> <span class="nf">get_twocol_string_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, with web-safing of value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="k">return</span> <span class="n">tr_qa</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">))</span></div>

<div class="viewcode-block" id="Task.get_twocol_bool_row"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_bool_row">[docs]</a>    <span class="k">def</span> <span class="nf">get_twocol_bool_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                            <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, with Boolean Y/N formatter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="k">return</span> <span class="n">tr_qa</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_yes_no_none</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Task.get_twocol_bool_row_true_false"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_bool_row_true_false">[docs]</a>    <span class="k">def</span> <span class="nf">get_twocol_bool_row_true_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                       <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                       <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, with Boolean T/F formatter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="k">return</span> <span class="n">tr_qa</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_true_false_none</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Task.get_twocol_bool_row_present_absent"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_bool_row_present_absent">[docs]</a>    <span class="k">def</span> <span class="nf">get_twocol_bool_row_present_absent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                           <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                           <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                           <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, with Boolean P/A formatter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="k">return</span> <span class="n">tr_qa</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_present_absent_none</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
                                                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Task.get_twocol_picture_row"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_twocol_picture_row">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_twocol_picture_row</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Blob</span><span class="p">],</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTML table row, two columns, with PNG on right.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tr</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_blob_img_html</span><span class="p">(</span><span class="n">blob</span><span class="p">))</span></div>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Field helper functions for subclasses</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

<div class="viewcode-block" id="Task.get_values"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.get_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get list of object&#39;s values from list of field names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span></div>

<div class="viewcode-block" id="Task.is_field_complete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.is_field_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_field_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the field not None?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Task.are_all_fields_complete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.are_all_fields_complete">[docs]</a>    <span class="k">def</span> <span class="nf">are_all_fields_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Are all fields not None?&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Task.n_complete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.n_complete">[docs]</a>    <span class="k">def</span> <span class="nf">n_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;How many of the fields are not None?&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="Task.n_incomplete"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.n_incomplete">[docs]</a>    <span class="k">def</span> <span class="nf">n_incomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;How many of the fields are None?&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="Task.count_booleans"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.count_booleans">[docs]</a>    <span class="k">def</span> <span class="nf">count_booleans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;How many fields evaluate to True?&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="Task.all_true"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.all_true">[docs]</a>    <span class="k">def</span> <span class="nf">all_true</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do all fields evaluate to True?&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Task.count_where"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.count_where">[docs]</a>    <span class="k">def</span> <span class="nf">count_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                    <span class="n">wherevalues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Count how many field values are in wherevalues.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wherevalues</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.count_wherenot"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.count_wherenot">[docs]</a>    <span class="k">def</span> <span class="nf">count_wherenot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">notvalues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Count how many field values are NOT in notvalues.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notvalues</span><span class="p">)</span></div>

<div class="viewcode-block" id="Task.sum_fields"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.sum_fields">[docs]</a>    <span class="k">def</span> <span class="nf">sum_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">ignorevalue</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Sum values stored in all fields (skipping any whose value is</span>
<span class="sd">        ignorevalue; treating fields containing None as zero).&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">ignorevalue</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">total</span></div>

<div class="viewcode-block" id="Task.mean_fields"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.Task.mean_fields">[docs]</a>    <span class="k">def</span> <span class="nf">mean_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                    <span class="n">ignorevalue</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mean of values stored in all fields (skipping any whose value is</span>
<span class="sd">        ignorevalue).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">ignorevalue</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">statistics</span><span class="o">.</span><span class="n">StatisticsError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fieldnames_from_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fieldnames_from_list</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">suffixes</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Extra strings</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">get_extrastring_taskname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrastring_taskname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>

    <span class="k">def</span> <span class="nf">extrastrings_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">task_extrastrings_exist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_extrastring_taskname</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">wxstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">defaultvalue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">provide_default_if_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">defaultvalue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">provide_default_if_none</span><span class="p">:</span>
            <span class="n">defaultvalue</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_extrastring_taskname</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">wxstring</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_extrastring_taskname</span><span class="p">(),</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">defaultvalue</span><span class="p">,</span>
            <span class="n">provide_default_if_none</span><span class="o">=</span><span class="n">provide_default_if_none</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">defaultvalue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">provide_default_if_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">defaultvalue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">provide_default_if_none</span><span class="p">:</span>
            <span class="n">defaultvalue</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_extrastring_taskname</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">xstring</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_extrastring_taskname</span><span class="p">(),</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">defaultvalue</span><span class="p">,</span>
            <span class="n">provide_default_if_none</span><span class="o">=</span><span class="n">provide_default_if_none</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Fieldnames to auto-exempt from text filtering</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@cache_region_static</span><span class="o">.</span><span class="n">cache_on_arguments</span><span class="p">(</span><span class="n">function_key_generator</span><span class="o">=</span><span class="n">fkg</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">text_filter_exempt_fields</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Task</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">exempt</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">gen_columns</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attrname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_sqlatype_string</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
            <span class="n">exempt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exempt</span>


<span class="k">def</span> <span class="nf">all_task_tables_with_min_client_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Version</span><span class="p">]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Version]</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">gen_all_subclasses</span><span class="p">())</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">all_tables_with_min_client_version</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Support functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_from_dict"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.get_from_dict">[docs]</a><span class="k">def</span> <span class="nf">get_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">INVALID_VALUE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns a value from a dictionary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Reports</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="TaskCountReport"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.TaskCountReport">[docs]</a><span class="k">class</span> <span class="nc">TaskCountReport</span><span class="p">(</span><span class="n">Report</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Report to count task instances.&quot;&quot;&quot;</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">report_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;taskcount&quot;</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;(Server) Count current task instances, by creation date&quot;</span>

    <span class="c1"># noinspection PyMethodParameters</span>
    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">superuser_only</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_rows_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlainReportType</span><span class="p">:</span>
        <span class="n">final_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_may_report_on</span>
        <span class="n">superuser</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">all_subclasses_by_tablename</span><span class="p">()</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">literal</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">),</span>
                <span class="c1"># func.year() is specific to some DBs, e.g. MySQL</span>
                <span class="c1"># so is func.extract(); http://modern-sql.com/feature/extract</span>
                <span class="n">extract_year</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_when_added_batch_utc</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">),</span>
                <span class="n">extract_month</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_when_added_batch_utc</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">),</span>
                <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;num_tasks_added&quot;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="n">select_from</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__table__</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="n">wheres</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_current</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>  <span class="c1"># nopep8</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">superuser</span><span class="p">:</span>
                <span class="c1"># Restrict to accessible groups</span>
                <span class="c1"># noinspection PyProtectedMember</span>
                <span class="n">wheres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_group_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">group_ids</span><span class="p">))</span>
            <span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">]</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">),</span> <span class="n">desc</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)]</span>
            <span class="c1"># ... http://docs.sqlalchemy.org/en/latest/core/tutorial.html#ordering-or-grouping-by-a-label  # noqa</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">select_fields</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">select_from</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">wheres</span><span class="p">))</span> \
                <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">*</span><span class="n">group_by</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_by</span><span class="p">)</span>
            <span class="c1"># log.critical(str(query))</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_rows_fieldnames_from_query</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">final_rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PlainReportType</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">final_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Unit testing</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="TaskTests"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_task.html#camcops_server.cc_modules.cc_task.TaskTests">[docs]</a><span class="k">class</span> <span class="nc">TaskTests</span><span class="p">(</span><span class="n">DemoDatabaseTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_query_phq9</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_query_phq9&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">camcops_server.tasks</span> <span class="k">import</span> <span class="n">Phq9</span>
        <span class="n">phq9_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Phq9</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">phq9_query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_all_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_all_tasks&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
        <span class="kn">import</span> <span class="nn">hl7</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.sql.schema</span> <span class="k">import</span> <span class="n">Column</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_ctvinfo</span> <span class="k">import</span> <span class="n">CtvInfo</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_simpleobjects</span> <span class="k">import</span> <span class="n">IdNumReference</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_summaryelement</span> <span class="k">import</span> <span class="n">SummaryElement</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_trackerhelpers</span> <span class="k">import</span> <span class="n">TrackerInfo</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_tsv</span> <span class="k">import</span> <span class="n">TsvPage</span>
        <span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_xml</span> <span class="k">import</span> <span class="n">XmlElement</span>

        <span class="n">subclasses</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">all_subclasses_by_tablename</span><span class="p">()</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">tablename</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">subclasses</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual task table names: </span><span class="si">{!r}</span><span class="s2"> (n=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">))</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span>
        <span class="n">recipdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipdef</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">subclasses</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># type: Task</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;Missing task!&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_complete</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_task_html</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">trackerinfo</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_trackers</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">trackerinfo</span><span class="p">,</span> <span class="n">TrackerInfo</span><span class="p">)</span>
            <span class="n">ctvlist</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_clinical_text</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ctvlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ctvinfo</span> <span class="ow">in</span> <span class="n">ctvlist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ctvinfo</span><span class="p">,</span> <span class="n">CtvInfo</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_extra_summary_tables</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">get_tsv_page</span><span class="p">(),</span> <span class="n">TsvPage</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">get_xml_element</span><span class="p">(),</span> <span class="n">XmlElement</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">has_patient</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">has_clinician</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">has_respondent</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_fieldnames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">field_contents_valid</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">field_contents_invalid_because</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_blob_fields</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_pk</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>  <span class="c1"># all our examples do have PKs  # noqa</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_preserved</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">was_forcibly_preserved</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_creation_datetime</span><span class="p">(),</span> <span class="n">Pendulum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get_creation_datetime_utc</span><span class="p">(),</span> <span class="n">Pendulum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get_seconds_from_creation_to_first_finish</span><span class="p">(),</span> <span class="nb">float</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_adding_user_id</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_adding_user_username</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_removing_user_username</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_preserving_user_username</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_manually_erasing_user_username</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">se</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">standard_task_summary_fields</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">SummaryElement</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_clinician_name</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_respondent_complete</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">patient</span><span class="p">,</span> <span class="n">Patient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_female</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_male</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_server_pk</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_forename</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_surname</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">dob</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_patient_dob</span><span class="p">()</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">dob</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">dob</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">dob</span><span class="p">,</span> <span class="n">Date</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstanceOrNone</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_dob_first11chars</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_sex</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_patient_address</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idnum</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_patient_idnum_objects</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">get_idnum_reference</span><span class="p">(),</span>
                                      <span class="n">IdNumReference</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">short_description</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">get_filename_component</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">pidseg</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_patient_hl7_pid_segment</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">recipdef</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pidseg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pidseg</span><span class="p">,</span> <span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dataseg</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_hl7_data_segments</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">recipdef</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dataseg</span><span class="p">,</span> <span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dataseg</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_hl7_extra_data_segments</span><span class="p">(</span><span class="n">recipdef</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dataseg</span><span class="p">,</span> <span class="n">hl7</span><span class="o">.</span><span class="n">Segment</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_erased</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_live_on_tablet</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">gen_text_filter_columns</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Column</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">get_tsv_pages</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">get_tsv</span><span class="p">(),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="c1"># *** replace test when anonymous export redone: get_cris_dd_rows</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_html</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_pdf</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_pdf_html</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">suggested_pdf_filename</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get_rio_metadata</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">uploading_user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">document_type</span><span class="o">=</span><span class="s2">&quot;some_doc_type&quot;</span><span class="p">),</span>
                <span class="nb">str</span>
            <span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_problems.html">21. Known problems: client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_problems.html#known-problems-server">22. Known problems: server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">23. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wishlist.html">24. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/local_info.html">25. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>