
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.cc_modules.webview &#8212; CamCOPS 2.2.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.cc_modules.webview</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/webview.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>
<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">===============================================================================</span>

<span class="sd">Quick tutorial on Pyramid views:</span>

<span class="sd">-   The configurator registers routes, and routes have URLs associated with</span>
<span class="sd">    them. Those URLs can be templatized, e.g. to accept numerical parameters.</span>
<span class="sd">    The configurator associates view callables (&quot;views&quot; for short) with routes,</span>
<span class="sd">    and one method for doing that is an automatic scan via Venusian for views</span>
<span class="sd">    decorated with @view_config().</span>

<span class="sd">-   All views take a Request object and return a Response or raise an exception</span>
<span class="sd">    that Pyramid will translate into a Response.</span>

<span class="sd">-   Having matched a route, Pyramid uses its &quot;view lookup&quot; process to choose</span>
<span class="sd">    one from potentially several views. For example, a single route might be</span>
<span class="sd">    associated with:</span>

<span class="sd">        @view_config(route_name=&quot;myroute&quot;)</span>
<span class="sd">        def myroute_default(req: Request) -&gt; Response:</span>
<span class="sd">            pass</span>

<span class="sd">        @view_config(route_name=&quot;myroute&quot;, method=&quot;POST&quot;)</span>
<span class="sd">        def myroute_post(req: Request) -&gt; Response:</span>
<span class="sd">            pass</span>

<span class="sd">    In this example, POST requests will go to the second; everything else will</span>
<span class="sd">    go to the first. Pyramid&#39;s view lookup rule is essentially: if multiple</span>
<span class="sd">    views match, choose the one with the most specifiers.</span>

<span class="sd">-   Specifiers include:</span>

<span class="sd">        route_name=ROUTENAME</span>

<span class="sd">            the route</span>

<span class="sd">        request_method=&quot;POST&quot;</span>

<span class="sd">            requires HTTP GET, POST, etc.</span>

<span class="sd">        request_param=&quot;XXX&quot;</span>

<span class="sd">            ... requires the presence of a GET/POST variable with this name in</span>
<span class="sd">            the request.params dictionary</span>

<span class="sd">        request_param=&quot;XXX=YYY&quot;</span>

<span class="sd">            ... requires the presence of a GET/POST variable called XXX whose</span>
<span class="sd">            value is YYY, in the request.params dictionary</span>

<span class="sd">        match_param=&quot;XXX=YYY&quot;</span>

<span class="sd">            .. requires the presence of this key/value pair in</span>
<span class="sd">            request.matchdict, which contains parameters from the URL</span>

<span class="sd">    https://docs.pylonsproject.org/projects/pyramid/en/latest/api/config.html#pyramid.config.Configurator.add_view  # noqa</span>

<span class="sd">-   Getting parameters</span>

<span class="sd">        request.params</span>

<span class="sd">            ... parameters from HTTP GET or POST, including both the query</span>
<span class="sd">            string (as in http://somewhere/path?key=value) and the body (e.g.</span>
<span class="sd">            POST).</span>

<span class="sd">        request.matchdict</span>

<span class="sd">            ... parameters from the URL, via URL dispatch; see</span>
<span class="sd">            https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/urldispatch.html#urldispatch-chapter  # noqa</span>

<span class="sd">-   Regarding rendering:</span>

<span class="sd">    There might be some simplicity benefits from converting to a template</span>
<span class="sd">    system like Mako. On the downside, that would entail a bit more work;</span>
<span class="sd">    likely a minor performance hit (relative to plain Python string rendering);</span>
<span class="sd">    and a loss of type checking. The type checking is also why we prefer:</span>

<span class="sd">        html = &quot; ... {param_blah} ...&quot;.format(param_blah=PARAM.BLAH)</span>

<span class="sd">    to</span>

<span class="sd">        html = &quot; ... {PARAM.BLAH} ...&quot;.format(PARAM=PARAM)</span>

<span class="sd">    as in the first situation, PyCharm will check that &quot;BLAH&quot; is present in</span>
<span class="sd">    &quot;PARAM&quot;, and in the second it won&#39;t. Automatic checking is worth a lot.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># from pprint import pformat</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.datetimefunc</span> <span class="k">import</span> <span class="n">format_datetime</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.deform_utils</span> <span class="k">import</span> <span class="n">get_head_form_html</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">BraceStyleAdapter</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.pyramid.responses</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">PdfResponse</span><span class="p">,</span>
    <span class="n">SqliteBinaryResponse</span><span class="p">,</span>
    <span class="n">TextAttachmentResponse</span><span class="p">,</span>
    <span class="n">XmlResponse</span><span class="p">,</span>
    <span class="n">ZipResponse</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.dialect</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_dialect_name</span><span class="p">,</span>
    <span class="n">SqlaDialectName</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.orm_inspect</span> <span class="k">import</span> <span class="n">gen_orm_classes_from_base</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.orm_query</span> <span class="k">import</span> <span class="n">CountStarSpecializedQuery</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.session</span> <span class="k">import</span> <span class="n">get_engine_from_session</span>
<span class="kn">from</span> <span class="nn">deform.exception</span> <span class="k">import</span> <span class="n">ValidationFailure</span>
<span class="kn">from</span> <span class="nn">pendulum</span> <span class="k">import</span> <span class="n">Pendulum</span>
<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="k">import</span> <span class="n">HTTPBadRequest</span><span class="p">,</span> <span class="n">HTTPFound</span><span class="p">,</span> <span class="n">HTTPNotFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">forbidden_view_config</span><span class="p">,</span>
    <span class="n">notfound_view_config</span><span class="p">,</span>
    <span class="n">view_config</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.renderers</span> <span class="k">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="k">import</span> <span class="n">FileResponse</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">Authenticated</span><span class="p">,</span> <span class="n">NO_PERMISSION_REQUIRED</span>
<span class="kn">import</span> <span class="nn">pygments</span>
<span class="kn">import</span> <span class="nn">pygments.lexers</span>
<span class="kn">import</span> <span class="nn">pygments.lexers.sql</span>
<span class="kn">import</span> <span class="nn">pygments.lexers.web</span>
<span class="kn">import</span> <span class="nn">pygments.formatters</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="k">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span> <span class="k">as</span> <span class="n">SqlASession</span><span class="p">,</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.functions</span> <span class="k">import</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="p">(</span><span class="n">and_</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">not_</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span>
                                       <span class="n">select</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.cc_audit</span> <span class="k">import</span> <span class="n">audit</span><span class="p">,</span> <span class="n">AuditEntry</span>
<span class="kn">from</span> <span class="nn">.cc_all_models</span> <span class="k">import</span> <span class="n">CLIENT_TABLE_MAP</span>
<span class="kn">from</span> <span class="nn">.cc_baseconstants</span> <span class="k">import</span> <span class="n">STATIC_ROOT_DIR</span>
<span class="kn">from</span> <span class="nn">.cc_constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CAMCOPS_URL</span><span class="p">,</span>
    <span class="n">DateFormat</span><span class="p">,</span>
    <span class="n">ERA_NOW</span><span class="p">,</span>
    <span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">,</span>
    <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_db</span> <span class="k">import</span> <span class="n">GenericTabletRecordMixin</span>
<span class="kn">from</span> <span class="nn">.cc_device</span> <span class="k">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">.cc_dump</span> <span class="k">import</span> <span class="n">copy_tasks_and_summaries</span>
<span class="kn">from</span> <span class="nn">.cc_forms</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AddGroupForm</span><span class="p">,</span>
    <span class="n">AddIdDefinitionForm</span><span class="p">,</span>
    <span class="n">AddSpecialNoteForm</span><span class="p">,</span>
    <span class="n">AddUserGroupadminForm</span><span class="p">,</span>
    <span class="n">AddUserSuperuserForm</span><span class="p">,</span>
    <span class="n">AuditTrailForm</span><span class="p">,</span>
    <span class="n">ChangeOtherPasswordForm</span><span class="p">,</span>
    <span class="n">ChangeOwnPasswordForm</span><span class="p">,</span>
    <span class="n">ChooseTrackerForm</span><span class="p">,</span>
    <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">,</span>
    <span class="n">DeleteGroupForm</span><span class="p">,</span>
    <span class="n">DeleteIdDefinitionForm</span><span class="p">,</span>
    <span class="n">DeletePatientChooseForm</span><span class="p">,</span>
    <span class="n">DeletePatientConfirmForm</span><span class="p">,</span>
    <span class="n">DeleteUserForm</span><span class="p">,</span>
    <span class="n">DIALECT_CHOICES</span><span class="p">,</span>
    <span class="n">EditGroupForm</span><span class="p">,</span>
    <span class="n">EditIdDefinitionForm</span><span class="p">,</span>
    <span class="n">EditPatientForm</span><span class="p">,</span>
    <span class="n">EDIT_PATIENT_SIMPLE_PARAMS</span><span class="p">,</span>
    <span class="n">EditServerSettingsForm</span><span class="p">,</span>
    <span class="n">EditUserFullForm</span><span class="p">,</span>
    <span class="n">EditUserGroupAdminForm</span><span class="p">,</span>
    <span class="n">EditUserGroupMembershipFullForm</span><span class="p">,</span>
    <span class="n">EditUserGroupMembershipGroupAdminForm</span><span class="p">,</span>
    <span class="n">EraseTaskForm</span><span class="p">,</span>
    <span class="n">ForciblyFinalizeChooseDeviceForm</span><span class="p">,</span>
    <span class="n">ForciblyFinalizeConfirmForm</span><span class="p">,</span>
    <span class="n">HL7MessageLogForm</span><span class="p">,</span>
    <span class="n">HL7RunLogForm</span><span class="p">,</span>
    <span class="n">LoginForm</span><span class="p">,</span>
    <span class="n">OfferBasicDumpForm</span><span class="p">,</span>
    <span class="n">OfferSqlDumpForm</span><span class="p">,</span>
    <span class="n">OfferTermsForm</span><span class="p">,</span>
    <span class="n">RefreshTasksForm</span><span class="p">,</span>
    <span class="n">SetUserUploadGroupForm</span><span class="p">,</span>
    <span class="n">EditTaskFilterForm</span><span class="p">,</span>
    <span class="n">TasksPerPageForm</span><span class="p">,</span>
    <span class="n">ViewDdlForm</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_group</span> <span class="k">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">.cc_hl7</span> <span class="k">import</span> <span class="n">HL7Message</span><span class="p">,</span> <span class="n">HL7Run</span>
<span class="kn">from</span> <span class="nn">.cc_idnumdef</span> <span class="k">import</span> <span class="n">IdNumDefinition</span>
<span class="kn">from</span> <span class="nn">.cc_membership</span> <span class="k">import</span> <span class="n">UserGroupMembership</span>
<span class="kn">from</span> <span class="nn">.cc_patient</span> <span class="k">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">.cc_patientidnum</span> <span class="k">import</span> <span class="n">PatientIdNum</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">import</span> <span class="nn">camcops_server.cc_modules.cc_plot</span>  <span class="c1"># import side effects (configure matplotlib)  # noqa</span>
<span class="kn">from</span> <span class="nn">.cc_pyramid</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CamcopsPage</span><span class="p">,</span>
    <span class="n">FormAction</span><span class="p">,</span>
    <span class="n">HTTPFoundDebugVersion</span><span class="p">,</span>
    <span class="n">PageUrl</span><span class="p">,</span>
    <span class="n">Permission</span><span class="p">,</span>
    <span class="n">Routes</span><span class="p">,</span>
    <span class="n">SqlalchemyOrmPage</span><span class="p">,</span>
    <span class="n">ViewArg</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_report</span> <span class="k">import</span> <span class="n">get_report_instance</span>
<span class="kn">from</span> <span class="nn">.cc_request</span> <span class="k">import</span> <span class="n">CamcopsRequest</span>
<span class="kn">from</span> <span class="nn">.cc_simpleobjects</span> <span class="k">import</span> <span class="n">IdNumReference</span>
<span class="kn">from</span> <span class="nn">.cc_specialnote</span> <span class="k">import</span> <span class="n">SpecialNote</span>
<span class="kn">from</span> <span class="nn">.cc_sqlalchemy</span> <span class="k">import</span> <span class="n">get_all_ddl</span>
<span class="kn">from</span> <span class="nn">.cc_task</span> <span class="k">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">.cc_taskfactory</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">task_factory</span><span class="p">,</span>
    <span class="n">TaskFilter</span><span class="p">,</span>
    <span class="n">TaskCollection</span><span class="p">,</span>
    <span class="n">TaskSortMethod</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_taskfilter</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">task_classes_from_table_names</span><span class="p">,</span>
    <span class="n">TaskClassSortMethod</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_tracker</span> <span class="k">import</span> <span class="n">ClinicalTextView</span><span class="p">,</span> <span class="n">Tracker</span>
<span class="kn">from</span> <span class="nn">.cc_tsv</span> <span class="k">import</span> <span class="n">TsvCollection</span>
<span class="kn">from</span> <span class="nn">.cc_user</span> <span class="k">import</span> <span class="n">SecurityAccountLockout</span><span class="p">,</span> <span class="n">SecurityLoginFailure</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">.cc_version</span> <span class="k">import</span> <span class="n">CAMCOPS_SERVER_VERSION</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Debugging options</span>
<span class="c1"># =============================================================================</span>

<span class="n">DEBUG_REDIRECT</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">DEBUG_REDIRECT</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Debugging options enabled!&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">DEBUG_REDIRECT</span><span class="p">:</span>
    <span class="n">HTTPFound</span> <span class="o">=</span> <span class="n">HTTPFoundDebugVersion</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">ALLOWED_TASK_VIEW_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDFHTML</span><span class="p">,</span>
                           <span class="n">ViewArg</span><span class="o">.</span><span class="n">XML</span><span class="p">]</span>
<span class="n">ALLOWED_TRACKER_VIEW_TYPE</span> <span class="o">=</span> <span class="p">[</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDFHTML</span><span class="p">,</span>
                             <span class="n">ViewArg</span><span class="o">.</span><span class="n">XML</span><span class="p">]</span>
<span class="n">CANNOT_DUMP</span> <span class="o">=</span> <span class="s2">&quot;User not authorized to dump data (for any group).&quot;</span>
<span class="n">CANNOT_REPORT</span> <span class="o">=</span> <span class="s2">&quot;User not authorized to run reports (for any group).&quot;</span>
<span class="c1"># CAN_ONLY_CHANGE_OWN_PASSWORD = &quot;You can only change your own password!&quot;</span>
<span class="c1"># TASK_FAIL_MSG = &quot;Task not found or user not authorized.&quot;</span>
<span class="c1"># NOT_AUTHORIZED_MSG = &quot;User not authorized.&quot;</span>
<span class="n">NO_INTROSPECTION_MSG</span> <span class="o">=</span> <span class="s2">&quot;Introspection has been disabled by your administrator.&quot;</span>
<span class="n">INTROSPECTION_INVALID_FILE_MSG</span> <span class="o">=</span> <span class="s2">&quot;Invalid file for introspection&quot;</span>
<span class="n">INTROSPECTION_FAILED_MSG</span> <span class="o">=</span> <span class="s2">&quot;Failed to read file for introspection&quot;</span>
<span class="n">ERROR_TASK_LIVE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Task is live on tablet; finalize (or force-finalize) first.&quot;</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Simple success/failure/redirection, and other snippets used by views</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="simple_success"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.simple_success">[docs]</a><span class="k">def</span> <span class="nf">simple_success</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">extra_html</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple success message.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;generic_success.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                   <span class="n">extra_html</span><span class="o">=</span><span class="n">extra_html</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="simple_failure"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.simple_failure">[docs]</a><span class="k">def</span> <span class="nf">simple_failure</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">extra_html</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple failure message.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;generic_failure.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                   <span class="n">extra_html</span><span class="o">=</span><span class="n">extra_html</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Unused</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># def query_result_html_core(req: CamcopsRequest,</span>
<span class="c1">#                            descriptions: Sequence[str],</span>
<span class="c1">#                            rows: Sequence[Sequence[Any]],</span>
<span class="c1">#                            null_html: str = &quot;&lt;i&gt;NULL&lt;/i&gt;&quot;) -&gt; str:</span>
<span class="c1">#     return render(&quot;query_result_core.mako&quot;,</span>
<span class="c1">#                   dict(descriptions=descriptions,</span>
<span class="c1">#                        rows=rows,</span>
<span class="c1">#                        null_html=null_html),</span>
<span class="c1">#                   request=req)</span>


<span class="c1"># def query_result_html_orm(req: CamcopsRequest,</span>
<span class="c1">#                           attrnames: List[str],</span>
<span class="c1">#                           descriptions: List[str],</span>
<span class="c1">#                           orm_objects: Sequence[Sequence[Any]],</span>
<span class="c1">#                           null_html: str = &quot;&lt;i&gt;NULL&lt;/i&gt;&quot;) -&gt; str:</span>
<span class="c1">#     return render(&quot;query_result_orm.mako&quot;,</span>
<span class="c1">#                   dict(attrnames=attrnames,</span>
<span class="c1">#                        descriptions=descriptions,</span>
<span class="c1">#                        orm_objects=orm_objects,</span>
<span class="c1">#                        null_html=null_html),</span>
<span class="c1">#                   request=req)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Error views</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># noinspection PyUnusedLocal</span>
<span class="nd">@notfound_view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;not_found.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="bad_request"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.bad_request">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">HTTPBadRequest</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;bad_request.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bad_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NOTE that this view only gets used from</span>
<span class="sd">        raise HTTPBadRequest(&quot;message&quot;)</span>
<span class="sd">    and not</span>
<span class="sd">        return HTTPBadRequest(&quot;message&quot;)</span>
<span class="sd">    ... so always raise it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{}</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Test pages</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Not on the menus...</span>

<span class="c1"># noinspection PyUnusedLocal</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PUBLIC_1</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_page_1</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Hello! This is a public CamCOPS test page.&quot;</span><span class="p">)</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_page_private_1</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Private test page.&quot;</span><span class="p">)</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_2</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;testpage.mako&quot;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_page_2</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># Contains POTENTIALLY SENSITIVE test information, including environment</span>
    <span class="c1"># variables</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">param1</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_3</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;inherit_cache_test_child.mako&quot;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_page_3</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="crash"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.crash">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CRASH</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">crash</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Deliberately raises an exception.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Deliberately crashed. Should not affect other &quot;</span>
                       <span class="s2">&quot;processes.&quot;</span><span class="p">)</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="developer_page"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.developer_page">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">DEVELOPER</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;developer.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">developer_page</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Shows developer menu.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{}</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Authorization: login, logout, login failures, terms/conditions</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Do NOT use extra parameters for functions decorated with @view_config;</span>
<span class="c1"># @view_config can take functions like &quot;def view(request)&quot; but also</span>
<span class="c1"># &quot;def view(context, request)&quot;, so if you add additional parameters, it thinks</span>
<span class="c1"># you&#39;re doing the latter and sends parameters accordingly.</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">LOGIN</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login_view</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
    <span class="n">autocomplete_password</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">disable_password_autocomplete</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">autocomplete_password</span><span class="o">=</span><span class="n">autocomplete_password</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="c1"># log.critical(&quot;controls from POST: {!r}&quot;, controls)</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># log.critical(&quot;appstruct from POST: {!r}&quot;, appstruct)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Validating user login.&quot;</span><span class="p">)</span>
            <span class="n">ccsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">)</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">)</span>
            <span class="c1"># 1. If we don&#39;t have a username, let&#39;s stop quickly.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
                <span class="n">ccsession</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">login_failed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="c1"># 2. Is the user locked?</span>
            <span class="k">if</span> <span class="n">SecurityAccountLockout</span><span class="o">.</span><span class="n">is_user_locked_out</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">account_locked</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
                                      <span class="n">User</span><span class="o">.</span><span class="n">user_locked_out_until</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="c1"># 3. Is the username/password combination correct?</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_from_username_password</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>  <span class="c1"># checks password</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">may_use_webviewer</span><span class="p">:</span>
                <span class="c1"># Successful login.</span>
                <span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>  <span class="c1"># will clear login failure record</span>
                <span class="n">ccsession</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This means a user who can upload from tablet but who cannot</span>
                <span class="c1"># log in via the web front end.</span>
                <span class="k">return</span> <span class="n">login_failed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Unsuccessful. Note that the username may/may not be genuine.</span>
                <span class="n">SecurityLoginFailure</span><span class="o">.</span><span class="n">act_on_login_failure</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                <span class="c1"># ... may lock the account</span>
                <span class="c1"># Now, call audit() before session.logout(), as the latter</span>
                <span class="c1"># will wipe the session IP address:</span>
                <span class="n">ccsession</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">login_failed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># OK, logged in.</span>
            <span class="c1"># Redirect to the main menu, or wherever the user was heading.</span>
            <span class="c1"># HOWEVER, that may lead us to a &quot;change password&quot; or &quot;agree terms&quot;</span>
            <span class="c1"># page, via the permissions system (Permission.HAPPY or not).</span>

            <span class="k">if</span> <span class="n">redirect_url</span><span class="p">:</span>
                <span class="c1"># log.critical(&quot;Redirecting to {!r}&quot;, redirect_url)</span>
                <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>  <span class="c1"># redirect</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>  <span class="c1"># redirect</span>

        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># ... use default of &quot;&quot;, because None gets serialized to &quot;None&quot;, which</span>
        <span class="c1">#     would then get read back later as &quot;None&quot;.</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">:</span> <span class="n">redirect_url</span><span class="p">}</span>
        <span class="c1"># log.critical(&quot;appstruct from GET/POST: {!r}&quot;, appstruct)</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;login.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span>


<div class="viewcode-block" id="login_failed"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.login_failed">[docs]</a><span class="k">def</span> <span class="nf">login_failed</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HTML given after login failure.</span>
<span class="sd">    Returned by login_view() only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;login_failed.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="account_locked"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.account_locked">[docs]</a><span class="k">def</span> <span class="nf">account_locked</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">locked_until</span><span class="p">:</span> <span class="n">Pendulum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HTML given when account locked out.</span>
<span class="sd">    Returned by login_view() only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;accounted_locked.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">locked_until</span><span class="o">=</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">locked_until</span><span class="p">,</span>
                                         <span class="n">DateFormat</span><span class="o">.</span><span class="n">LONG_DATETIME_WITH_DAY</span><span class="p">,</span>
                                         <span class="s2">&quot;(never)&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.logout">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">LOGOUT</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;logged_out.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Logs a session out.&quot;&quot;&quot;</span>
    <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Logout&quot;</span><span class="p">)</span>
    <span class="n">ccsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span>
    <span class="n">ccsession</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="offer_terms"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.offer_terms">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_TERMS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Authenticated</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;offer_terms.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_terms</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;HTML offering terms/conditions and requesting acknowledgement.&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">OfferTermsForm</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
        <span class="n">agree_button_text</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">wappstring</span><span class="p">(</span><span class="s2">&quot;disclaimer_agree&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">agree_terms</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>  <span class="c1"># redirect</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;offer_terms.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">wappstring</span><span class="p">(</span><span class="s2">&quot;disclaimer_title&quot;</span><span class="p">),</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">wappstring</span><span class="p">(</span><span class="s2">&quot;disclaimer_subtitle&quot;</span><span class="p">),</span>
            <span class="n">content</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">wappstring</span><span class="p">(</span><span class="s2">&quot;disclaimer_content&quot;</span><span class="p">),</span>
            <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(),</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<span class="nd">@forbidden_view_config</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">forbidden</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="c1"># I was doing this:</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">Authenticated</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
        <span class="k">assert</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot;Bug! Authenticated but no user...!?&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">must_change_password</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHANGE_OWN_PASSWORD</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">must_agree_terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_TERMS</span><span class="p">))</span>
    <span class="c1"># ... but with &quot;raise HTTPFound&quot; instead.</span>
    <span class="c1"># BUT there is only one level of exception handling in Pyramid, i.e. you</span>
    <span class="c1"># can&#39;t raise exceptions from exceptions:</span>
    <span class="c1">#       https://github.com/Pylons/pyramid/issues/436</span>
    <span class="c1"># The simplest way round is to use &quot;return&quot;, not &quot;raise&quot;.</span>

    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span>
    <span class="c1"># Redirects to login page, with onwards redirection to requested</span>
    <span class="c1"># destination once logged in:</span>
    <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">:</span> <span class="n">redirect_url</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;forbidden.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">querydict</span><span class="o">=</span><span class="n">querydict</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Changing passwords</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHANGE_OWN_PASSWORD</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">Authenticated</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">change_own_password</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
    <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">expired</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">must_change_password</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ChangeOwnPasswordForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">must_differ</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extra_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Change the password</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NEW_PASSWORD</span><span class="p">)</span>
            <span class="c1"># ... form will validate old password, etc.</span>
            <span class="c1"># OK</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">password_changed</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">own_password</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;change_own_password.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">expired</span><span class="o">=</span><span class="n">expired</span><span class="p">,</span>
             <span class="n">extra_msg</span><span class="o">=</span><span class="n">extra_msg</span><span class="p">,</span>
             <span class="n">min_pw_length</span><span class="o">=</span><span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<div class="viewcode-block" id="change_other_password"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.change_other_password">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHANGE_OTHER_PASSWORD</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;change_other_password.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">change_other_password</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;For administrators, to change another&#39;s password.&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ChangeOtherPasswordForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># for type checker</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Change the password</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">change_own_password</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">must_change_pw</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">MUST_CHANGE_PASSWORD</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NEW_PASSWORD</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Missing user for id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
            <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">must_change_pw</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">force_password_change</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">password_changed</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">own_password</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Improper user_id of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">change_own_password</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Missing user for id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
        <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;change_other_password.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
             <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">min_pw_length</span><span class="o">=</span><span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">password_changed</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                     <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">own_password</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;password_changed.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                   <span class="n">own_password</span><span class="o">=</span><span class="n">own_password</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Main menu; simple information things</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="main_menu"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.main_menu">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;main_menu.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main_menu</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Main HTML menu.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span>  <span class="c1"># type: Iterable[Group]</span>
        <span class="n">warn_bad_id_policies</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">tokenized_upload_policy</span><span class="p">()</span><span class="o">.</span><span class="n">is_valid_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="ow">or</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">tokenized_finalize_policy</span><span class="p">()</span><span class="o">.</span><span class="n">is_valid_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Let&#39;s make things a little faster for non-superusers:</span>
        <span class="n">warn_bad_id_policies</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">authorized_as_groupadmin</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_as_groupadmin</span><span class="p">,</span>
        <span class="n">authorized_as_superuser</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">,</span>
        <span class="n">authorized_for_reports</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_for_reports</span><span class="p">,</span>
        <span class="n">authorized_to_dump</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_to_dump</span><span class="p">,</span>
        <span class="n">camcops_url</span><span class="o">=</span><span class="n">CAMCOPS_URL</span><span class="p">,</span>
        <span class="n">warn_bad_id_policies</span><span class="o">=</span><span class="n">warn_bad_id_policies</span><span class="p">,</span>
        <span class="n">introspection</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">introspection</span><span class="p">,</span>
        <span class="n">now</span><span class="o">=</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">DateFormat</span><span class="o">.</span><span class="n">SHORT_DATETIME_SECONDS</span><span class="p">),</span>
        <span class="n">server_version</span><span class="o">=</span><span class="n">CAMCOPS_SERVER_VERSION</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Tasks</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">edit_filter</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">task_filter</span><span class="p">:</span> <span class="n">TaskFilter</span><span class="p">,</span>
                <span class="n">redirect_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SET_FILTERS</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditTaskFilterForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">fa</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply the changes</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">who</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHO</span><span class="p">)</span>
            <span class="n">what</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHAT</span><span class="p">)</span>
            <span class="n">when</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHEN</span><span class="p">)</span>
            <span class="n">admin</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">surname</span> <span class="o">=</span> <span class="n">who</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SURNAME</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">forename</span> <span class="o">=</span> <span class="n">who</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">FORENAME</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">dob</span> <span class="o">=</span> <span class="n">who</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DOB</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">sex</span> <span class="o">=</span> <span class="n">who</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SEX</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">idnum_criteria</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">IdNumReference</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">],</span>
                               <span class="n">idnum_value</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">who</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ID_REFERENCES</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">task_types</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">text_contents</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TEXT_CONTENTS</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">complete_only</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">COMPLETE_ONLY</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">when</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">when</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">device_ids</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DEVICE_IDS</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">adding_user_ids</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_IDS</span><span class="p">)</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">group_ids</span> <span class="o">=</span> <span class="n">admin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CLEAR_FILTERS</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="c1"># skip validation</span>
            <span class="n">task_filter</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">who</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SURNAME</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">surname</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">FORENAME</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">forename</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">DOB</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">dob</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SEX</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">sex</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">ID_REFERENCES</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
                 <span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">idnum_criteria</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="n">what</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">task_types</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TEXT_CONTENTS</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">text_contents</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">COMPLETE_ONLY</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">complete_only</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">when</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">DEVICE_IDS</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">device_ids</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_IDS</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">adding_user_ids</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">:</span> <span class="n">task_filter</span><span class="o">.</span><span class="n">group_ids</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">open_who</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">who</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">open_what</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">what</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">open_when</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">when</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">open_admin</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">admin</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">fa</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHO</span><span class="p">:</span> <span class="n">who</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHAT</span><span class="p">:</span> <span class="n">what</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHEN</span><span class="p">:</span> <span class="n">when</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">:</span> <span class="n">admin</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditTaskFilterForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                                  <span class="n">open_admin</span><span class="o">=</span><span class="n">open_admin</span><span class="p">,</span>
                                  <span class="n">open_what</span><span class="o">=</span><span class="n">open_what</span><span class="p">,</span>
                                  <span class="n">open_when</span><span class="o">=</span><span class="n">open_when</span><span class="p">,</span>
                                  <span class="n">open_who</span><span class="o">=</span><span class="n">open_who</span><span class="p">)</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;filter_edit.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_FILTERS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_filters</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">,</span>
                                     <span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_TASKS</span><span class="p">))</span>
    <span class="n">task_filter</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span><span class="o">.</span><span class="n">get_task_filter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">edit_filter</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">task_filter</span><span class="o">=</span><span class="n">task_filter</span><span class="p">,</span> <span class="n">redirect_url</span><span class="o">=</span><span class="n">redirect_url</span><span class="p">)</span>


<div class="viewcode-block" id="view_tasks"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.view_tasks">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_TASKS</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;view_tasks.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_tasks</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;HTML displaying tasks and applicable filters.&quot;&quot;&quot;</span>
    <span class="n">ccsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
    <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">ccsession</span><span class="o">.</span><span class="n">get_task_filter</span><span class="p">()</span>

    <span class="c1"># Read from the GET parameters (or in some cases potentially POST but those</span>
    <span class="c1"># will be re-read).</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span>
        <span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
        <span class="n">ccsession</span><span class="o">.</span><span class="n">number_to_view</span> <span class="ow">or</span> <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># &quot;Number of tasks per page&quot; form</span>
    <span class="n">tpp_form</span> <span class="o">=</span> <span class="n">TasksPerPageForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">css_class</span><span class="o">=</span><span class="s2">&quot;form-inline&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT_TASKS_PER_PAGE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">tpp_appstruct</span> <span class="o">=</span> <span class="n">tpp_form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">tpp_appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">)</span>
            <span class="n">ccsession</span><span class="o">.</span><span class="n">number_to_view</span> <span class="o">=</span> <span class="n">rows_per_page</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">rendered_tpp_form</span> <span class="o">=</span> <span class="n">tpp_form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpp_appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">:</span> <span class="n">rows_per_page</span><span class="p">}</span>
        <span class="n">rendered_tpp_form</span> <span class="o">=</span> <span class="n">tpp_form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">tpp_appstruct</span><span class="p">)</span>

    <span class="c1"># Refresh tasks. Slightly pointless. Doesn&#39;t need validating. The user</span>
    <span class="c1"># could just press the browser&#39;s refresh button, but this improves the UI</span>
    <span class="c1"># slightly.</span>
    <span class="n">refresh_form</span> <span class="o">=</span> <span class="n">RefreshTasksForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">rendered_refresh_form</span> <span class="o">=</span> <span class="n">refresh_form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="c1"># Get tasks, unless there have been form errors.</span>
    <span class="c1"># In principle, for some filter settings (single task, no &quot;complete&quot;</span>
    <span class="c1"># preference...) we could produce an ORM query and use SqlalchemyOrmPage,</span>
    <span class="c1"># which would apply LIMIT/OFFSET (or equivalent) to the query, and be</span>
    <span class="c1"># very nippy. In practice, this is probably an unusual setting, so we&#39;ll</span>
    <span class="c1"># simplify things here with a Python list regardless of the settings.</span>
    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
            <span class="n">sort_method_global</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_DESC</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all_tasks</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">CamcopsPage</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                       <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                       <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                       <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
        <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">tpp_form</span><span class="p">,</span>
                                                <span class="n">refresh_form</span><span class="p">]),</span>
        <span class="n">tpp_form</span><span class="o">=</span><span class="n">rendered_tpp_form</span><span class="p">,</span>
        <span class="n">refresh_form</span><span class="o">=</span><span class="n">rendered_refresh_form</span><span class="p">,</span>
        <span class="n">no_patient_selected_and_user_restricted</span><span class="o">=</span><span class="p">(</span>
            <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">may_view_all_patients_when_unfiltered</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">taskfilter</span><span class="o">.</span><span class="n">any_specific_patient_filtering</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="serve_task"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.serve_task">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TASK</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_task</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Serves an individual task.&quot;&quot;&quot;</span>
    <span class="n">viewtype</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEWTYPE</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tablename</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">)</span>
    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">)</span>
    <span class="n">anonymise</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ANONYMISE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">viewtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_TASK_VIEW_TYPES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span>
            <span class="s2">&quot;Bad output type: </span><span class="si">{!r}</span><span class="s2"> (permissible: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">viewtype</span><span class="p">,</span> <span class="n">ALLOWED_TASK_VIEW_TYPES</span><span class="p">))</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">task_factory</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPNotFound</span><span class="p">(</span>
            <span class="s2">&quot;Task not found or not permitted: tablename=</span><span class="si">{!r}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;server_pk=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">))</span>

    <span class="n">task</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Viewed &quot;</span> <span class="o">+</span> <span class="n">viewtype</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">task</span><span class="o">.</span><span class="n">get_html</span><span class="p">(</span><span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PdfResponse</span><span class="p">(</span>
            <span class="n">body</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">get_pdf</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">),</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">suggested_pdf_filename</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDFHTML</span><span class="p">:</span>  <span class="c1"># debugging option</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">task</span><span class="o">.</span><span class="n">get_pdf_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">anonymise</span><span class="o">=</span><span class="n">anonymise</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">XML</span><span class="p">:</span>
        <span class="n">include_blobs</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_BLOBS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">include_calculated</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_CALCULATED</span><span class="p">,</span>
                                                <span class="kc">True</span><span class="p">)</span>
        <span class="n">include_patient</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_PATIENT</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">include_comments</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_COMMENTS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">XmlResponse</span><span class="p">(</span>
            <span class="n">task</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                         <span class="n">include_blobs</span><span class="o">=</span><span class="n">include_blobs</span><span class="p">,</span>
                         <span class="n">include_calculated</span><span class="o">=</span><span class="n">include_calculated</span><span class="p">,</span>
                         <span class="n">include_patient</span><span class="o">=</span><span class="n">include_patient</span><span class="p">,</span>
                         <span class="n">include_comments</span><span class="o">=</span><span class="n">include_comments</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Bug in logic above&quot;</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Trackers, CTVs</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="choose_tracker_or_ctv"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.choose_tracker_or_ctv">[docs]</a><span class="k">def</span> <span class="nf">choose_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">as_ctv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;HTML form for tracker selection.&quot;&quot;&quot;</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">ChooseTrackerForm</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">as_ctv</span><span class="o">=</span><span class="n">as_ctv</span><span class="p">,</span> <span class="n">css_class</span><span class="o">=</span><span class="s2">&quot;form-inline&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">ALL_TASKS</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEWTYPE</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
            <span class="c1"># Not so obvious this can be redirected cleanly via POST.</span>
            <span class="c1"># It is possible by returning a form that then autosubmits: see</span>
            <span class="c1"># https://stackoverflow.com/questions/46582/response-redirect-with-post-instead-of-get  # noqa</span>
            <span class="c1"># However, since everything&#39;s on this server, we could just return</span>
            <span class="c1"># an appropriate Response directly. But the request information is</span>
            <span class="c1"># not sensitive, so we lose nothing by using a GET redirect:</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span>
                <span class="n">Routes</span><span class="o">.</span><span class="n">CTV</span> <span class="k">if</span> <span class="n">as_ctv</span> <span class="k">else</span> <span class="n">Routes</span><span class="o">.</span><span class="n">TRACKER</span><span class="p">,</span>
                <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHOOSE_TRACKER</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;choose_tracker.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">choose_tracker</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">choose_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">as_ctv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHOOSE_CTV</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;choose_ctv.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">choose_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">choose_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">as_ctv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">serve_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                         <span class="n">as_ctv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">which_idnum</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">)</span>
    <span class="n">idnum_value</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">)</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">)</span>
    <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_list_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">)</span>
    <span class="n">all_tasks</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ALL_TASKS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">viewtype</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEWTYPE</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_tasks</span><span class="p">:</span>
        <span class="n">task_classes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Type[Task]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">task_classes</span> <span class="o">=</span> <span class="n">task_classes_from_table_names</span><span class="p">(</span>
                <span class="n">tasks</span><span class="p">,</span> <span class="n">sortmethod</span><span class="o">=</span><span class="n">TaskClassSortMethod</span><span class="o">.</span><span class="n">SHORTNAME</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Invalid tasks specified&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">provides_trackers</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">task_classes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Not all tasks specified provide trackers&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">viewtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_TRACKER_VIEW_TYPE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Invalid view type&quot;</span><span class="p">)</span>

    <span class="n">iddefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">IdNumReference</span><span class="p">(</span><span class="n">which_idnum</span><span class="p">,</span> <span class="n">idnum_value</span><span class="p">)]</span>

    <span class="n">as_tracker</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">as_ctv</span>
    <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">task_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">tc</span><span class="o">.</span><span class="n">__tablename__</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">task_classes</span><span class="p">]</span>  <span class="c1"># a bit silly...  # noqa</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">idnum_criteria</span> <span class="o">=</span> <span class="n">iddefs</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">start_datetime</span> <span class="o">=</span> <span class="n">start_datetime</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">end_datetime</span> <span class="o">=</span> <span class="n">end_datetime</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">complete_only</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># trackers require complete tasks</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">sort_method</span> <span class="o">=</span> <span class="n">TaskClassSortMethod</span><span class="o">.</span><span class="n">SHORTNAME</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">tasks_offering_trackers_only</span> <span class="o">=</span> <span class="n">as_tracker</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">tasks_with_patient_only</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">tracker_ctv_class</span> <span class="o">=</span> <span class="n">ClinicalTextView</span> <span class="k">if</span> <span class="n">as_ctv</span> <span class="k">else</span> <span class="n">Tracker</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">tracker_ctv_class</span><span class="p">(</span><span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">get_html</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDF</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PdfResponse</span><span class="p">(</span>
            <span class="n">body</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_pdf</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">suggested_pdf_filename</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">PDFHTML</span><span class="p">:</span>  <span class="c1"># debugging option</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">get_pdf_html</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">viewtype</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">XML</span><span class="p">:</span>
        <span class="n">include_comments</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_COMMENTS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">XmlResponse</span><span class="p">(</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="n">include_comments</span><span class="o">=</span><span class="n">include_comments</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Bug in logic above&quot;</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TRACKER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_tracker</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">serve_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">as_ctv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CTV</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">serve_tracker_or_ctv</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">as_ctv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Reports</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="reports_menu"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.reports_menu">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">REPORTS_MENU</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;reports_menu.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reports_menu</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Offer a menu of reports.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_for_reports</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_REPORT</span><span class="p">)</span>
    <span class="c1"># Reports are not group-specific.</span>
    <span class="c1"># If you&#39;re authorized to see any, you&#39;ll see the whole menu.</span>
    <span class="c1"># (The *data* you get will be restricted to the group&#39;s you&#39;re authorized</span>
    <span class="c1"># to run reports for.)</span>
    <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="offer_report"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.offer_report">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_REPORT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_report</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Offer configuration options for a single report, or (following submission)</span>
<span class="sd">    redirect to serve that report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_for_reports</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_REPORT</span><span class="p">)</span>
    <span class="n">report_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REPORT_ID</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">get_report_instance</span><span class="p">(</span><span class="n">report_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such report ID: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">superuser_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Report </span><span class="si">{!r}</span><span class="s2"> is restricted to the &quot;</span>
                             <span class="s2">&quot;superuser&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_id</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get_form</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>  <span class="c1"># may raise</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get_http_query_keys</span><span class="p">()</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
            <span class="n">querydict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REPORT_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_id</span>
            <span class="n">querydict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Send the user to the actual data using GET: this allows page</span>
            <span class="c1"># navigation whilst maintaining any report-specific parameters.</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span> <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">({</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REPORT_ID</span><span class="p">:</span> <span class="n">report_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;report_offer.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="serve_report"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.serve_report">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">REPORT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_report</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serve a configured report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_for_reports</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_REPORT</span><span class="p">)</span>
    <span class="n">report_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REPORT_ID</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">get_report_instance</span><span class="p">(</span><span class="n">report_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such report ID: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">superuser_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Report </span><span class="si">{!r}</span><span class="s2"> is restricted to the &quot;</span>
                             <span class="s2">&quot;superuser&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">report</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Research downloads</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="offer_tsv_dump"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.offer_tsv_dump">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_TSV_DUMP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_tsv_dump</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Form for basic research dump selection.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_to_dump</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_DUMP</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">OfferBasicDumpForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">manual</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">MANUAL</span><span class="p">)</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">),</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">SORT</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SORT</span><span class="p">),</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">:</span> <span class="n">manual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">),</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">:</span> <span class="n">manual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="c1"># We could return a response, or redirect via GET.</span>
            <span class="c1"># The request is not sensitive, so let&#39;s redirect.</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TSV_DUMP</span><span class="p">,</span>
                                           <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;dump_basic_offer.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">TSV_DUMP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_tsv_dump</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_to_dump</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_DUMP</span><span class="p">)</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Get parameters</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">dump_method</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">)</span>
    <span class="n">sort_by_heading</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SORT</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_list_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>
    <span class="n">task_names</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_list_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Select tasks</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">EVERYTHING</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">USE_SESSION_FILTER</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span><span class="o">.</span><span class="n">get_task_filter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">SPECIFIC_TASKS_GROUPS</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
        <span class="n">taskfilter</span><span class="o">.</span><span class="n">task_types</span> <span class="o">=</span> <span class="n">task_names</span>
        <span class="n">taskfilter</span><span class="o">.</span><span class="n">group_ids</span> <span class="o">=</span> <span class="n">group_ids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad </span><span class="si">{}</span><span class="s2"> parameter&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">))</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
        <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
        <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
        <span class="n">as_dump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sort_method_by_class</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_ASC</span>
    <span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Create memory file and ZIP file within it</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">memfile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">memfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Iterate through tasks</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">audit_descriptions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">task_classes</span><span class="p">():</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">tasks_for_task_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># Task may return &gt;1 file for TSV output (e.g. for subtables).</span>
        <span class="n">tsvcoll</span> <span class="o">=</span> <span class="n">TsvCollection</span><span class="p">()</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[int]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="n">pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_pk</span><span class="p">)</span>
            <span class="n">tsv_pages</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_tsv_pages</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">tsvcoll</span><span class="o">.</span><span class="n">add_pages</span><span class="p">(</span><span class="n">tsv_pages</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort_by_heading</span><span class="p">:</span>
            <span class="n">tsvcoll</span><span class="o">.</span><span class="n">sort_headings_within_all_pages</span><span class="p">()</span>

        <span class="n">audit_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">)))</span>

        <span class="c1"># Write to ZIP.</span>
        <span class="c1"># If there are no valid task instances, there&#39;ll be no TSV; that&#39;s OK.</span>
        <span class="k">for</span> <span class="n">filename_stem</span> <span class="ow">in</span> <span class="n">tsvcoll</span><span class="o">.</span><span class="n">get_page_names</span><span class="p">():</span>
            <span class="n">tsv_filename</span> <span class="o">=</span> <span class="n">filename_stem</span> <span class="o">+</span> <span class="s2">&quot;.tsv&quot;</span>
            <span class="n">tsv_contents</span> <span class="o">=</span> <span class="n">tsvcoll</span><span class="o">.</span><span class="n">get_tsv_file</span><span class="p">(</span><span class="n">filename_stem</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">tsv_filename</span><span class="p">,</span> <span class="n">tsv_contents</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="c1"># Attempt a little memory efficiency:</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">forget_task_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Finish and serve</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Audit</span>
    <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;Basic dump: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">audit_descriptions</span><span class="p">)))</span>

    <span class="c1"># Return the result</span>
    <span class="n">zip_contents</span> <span class="o">=</span> <span class="n">memfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">memfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">zip_filename</span> <span class="o">=</span> <span class="s2">&quot;CamCOPS_dump_</span><span class="si">{}</span><span class="s2">.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">format_datetime</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">DateFormat</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ZipResponse</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">zip_contents</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">zip_filename</span><span class="p">)</span>


<div class="viewcode-block" id="offer_sql_dump"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.offer_sql_dump">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_SQL_DUMP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_sql_dump</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Form for SQL research dump selection.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_to_dump</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_DUMP</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">OfferSqlDumpForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">manual</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">MANUAL</span><span class="p">)</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">),</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">SQLITE_METHOD</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SQLITE_METHOD</span><span class="p">),</span>  <span class="c1"># noqa</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_BLOBS</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_BLOBS</span><span class="p">),</span>  <span class="c1"># noqa</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">:</span> <span class="n">manual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">),</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">:</span> <span class="n">manual</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="c1"># We could return a response, or redirect via GET.</span>
            <span class="c1"># The request is not sensitive, so let&#39;s redirect.</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">SQL_DUMP</span><span class="p">,</span> <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;dump_sql_offer.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">SQL_DUMP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sql_dump</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">authorized_to_dump</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">CANNOT_DUMP</span><span class="p">)</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Get parameters</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">dump_method</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">)</span>
    <span class="n">sqlite_method</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SQLITE_METHOD</span><span class="p">)</span>
    <span class="n">include_blobs</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">INCLUDE_BLOBS</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_list_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>
    <span class="n">task_names</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_list_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TASKS</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Select tasks</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">EVERYTHING</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">USE_SESSION_FILTER</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">camcops_session</span><span class="o">.</span><span class="n">get_task_filter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dump_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">SPECIFIC_TASKS_GROUPS</span><span class="p">:</span>
        <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
        <span class="n">taskfilter</span><span class="o">.</span><span class="n">task_types</span> <span class="o">=</span> <span class="n">task_names</span>
        <span class="n">taskfilter</span><span class="o">.</span><span class="n">group_ids</span> <span class="o">=</span> <span class="n">group_ids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad </span><span class="si">{}</span><span class="s2"> parameter&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DUMP_METHOD</span><span class="p">))</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
        <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
        <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
        <span class="n">as_dump</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sort_method_by_class</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_ASC</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sqlite_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ViewArg</span><span class="o">.</span><span class="n">SQL</span><span class="p">,</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">SQLITE</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad </span><span class="si">{}</span><span class="s2"> parameter&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SQLITE_METHOD</span><span class="p">))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Create memory file, dumper, and engine</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># This approach failed:</span>
    <span class="c1">#</span>
    <span class="c1">#   memfile = io.StringIO()</span>
    <span class="c1">#</span>
    <span class="c1">#   def dump(querysql, *multiparams, **params):</span>
    <span class="c1">#       compsql = querysql.compile(dialect=engine.dialect)</span>
    <span class="c1">#       memfile.write(&quot;{};\n&quot;.format(compsql))</span>
    <span class="c1">#</span>
    <span class="c1">#   engine = create_engine(&#39;{dialect}://&#39;.format(dialect=dialect_name),</span>
    <span class="c1">#                          strategy=&#39;mock&#39;, executor=dump)</span>
    <span class="c1">#   dst_session = sessionmaker(bind=engine)()  # type: SqlASession</span>
    <span class="c1">#</span>
    <span class="c1"># ... you get the error</span>
    <span class="c1">#   AttributeError: &#39;MockConnection&#39; object has no attribute &#39;begin&#39;</span>
    <span class="c1"># ... which is fair enough.</span>
    <span class="c1">#</span>
    <span class="c1"># Next best thing: SQLite database.</span>
    <span class="c1"># Two ways to deal with it:</span>
    <span class="c1"># (a) duplicate our C++ dump code (which itself duplicate the SQLite</span>
    <span class="c1">#     command-line executable&#39;s dump facility), then create the database,</span>
    <span class="c1">#     dump it to a string, serve the string; or</span>
    <span class="c1"># (b) offer the binary SQLite file.</span>
    <span class="c1"># Or... (c) both.</span>
    <span class="c1"># Aha! pymysqlite.iterdump does this for us.</span>
    <span class="c1">#</span>
    <span class="c1"># If we create an in-memory database using create_engine(&#39;sqlite://&#39;),</span>
    <span class="c1"># can we get the binary contents out? Don&#39;t think so.</span>
    <span class="c1">#</span>
    <span class="c1"># So we should first create a temporary on-disk file, then use that.</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Make temporary file (one whose filename we can know).</span>
    <span class="c1"># We use tempfile.mkstemp() for security, or NamedTemporaryFile,</span>
    <span class="c1"># which is a bit easier. However, you can&#39;t necessarily open the file</span>
    <span class="c1"># again under all OSs, so that&#39;s no good. The final option is</span>
    <span class="c1"># TemporaryDirectory, which is secure and convenient.</span>
    <span class="c1">#</span>
    <span class="c1"># https://docs.python.org/3/library/tempfile.html</span>
    <span class="c1"># https://security.openstack.org/guidelines/dg_using-temporary-files-securely.html  # noqa</span>
    <span class="c1"># https://stackoverflow.com/questions/3924117/how-to-use-tempfile-namedtemporaryfile-in-python  # noqa</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">db_basename</span> <span class="o">=</span> <span class="s2">&quot;temp.sqlite3&quot;</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">db_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="n">db_basename</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Make SQLAlchemy session</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///&quot;</span> <span class="o">+</span> <span class="n">db_filename</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dst_session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>  <span class="c1"># type: SqlASession</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Iterate through tasks, creating tables as we need them.</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Must treat tasks all together, because otherwise we will insert</span>
        <span class="c1"># duplicate dependency objects like Group objects.</span>
        <span class="n">audit_descriptions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="n">all_tasks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Task]</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">task_classes</span><span class="p">():</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">tasks_for_task_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">all_tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="n">audit_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">)))</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Next bit very tricky. We&#39;re trying to achieve several things:</span>
        <span class="c1"># - a copy of part of the database structure</span>
        <span class="c1"># - a copy of part of the data, with relationships intact</span>
        <span class="c1"># - nothing sensitive (e.g. full User records) going through</span>
        <span class="c1"># - adding new columns for Task objects offering summary values</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">copy_tasks_and_summaries</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="n">all_tasks</span><span class="p">,</span>
                                 <span class="n">dst_engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                                 <span class="n">dst_session</span><span class="o">=</span><span class="n">dst_session</span><span class="p">,</span>
                                 <span class="n">include_blobs</span><span class="o">=</span><span class="n">include_blobs</span><span class="p">,</span>
                                 <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">dst_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Audit</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;SQL dump: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">audit_descriptions</span><span class="p">)))</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Fetch file contents, either as binary, or as SQL</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="n">filename_stem</span> <span class="o">=</span> <span class="s2">&quot;CamCOPS_dump_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">format_datetime</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">DateFormat</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sqlite_method</span> <span class="o">==</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">SQLITE</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">db_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">binary_contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">SqliteBinaryResponse</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">binary_contents</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="o">=</span><span class="n">filename_stem</span> <span class="o">+</span> <span class="s2">&quot;.sqlite3&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># SQL</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">sql_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">TextAttachmentResponse</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">sql_text</span><span class="p">,</span>
                                          <span class="n">filename</span><span class="o">=</span><span class="n">filename_stem</span> <span class="o">+</span> <span class="s2">&quot;.sql&quot;</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># View DDL (table definitions)</span>
<span class="c1"># =============================================================================</span>

<span class="n">LEXERMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">MySqlLexer</span><span class="p">,</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SqlLexer</span><span class="p">,</span>  <span class="c1"># generic</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">ORACLE</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SqlLexer</span><span class="p">,</span>  <span class="c1"># generic</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">FIREBIRD</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SqlLexer</span><span class="p">,</span>  <span class="c1"># generic</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">POSTGRES</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">PostgresLexer</span><span class="p">,</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SQLITE</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SqlLexer</span><span class="p">,</span>  <span class="c1"># generic; SqliteConsoleLexer is wrong  # noqa</span>
    <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SYBASE</span><span class="p">:</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SqlLexer</span><span class="p">,</span>  <span class="c1"># generic</span>
<span class="p">}</span>


<div class="viewcode-block" id="view_ddl"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.view_ddl">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_DDL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_ddl</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Inspect table definitions with field comments.&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ViewDdlForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">dialect</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DIALECT</span><span class="p">)</span>
            <span class="n">ddl</span> <span class="o">=</span> <span class="n">get_all_ddl</span><span class="p">(</span><span class="n">dialect_name</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
            <span class="n">lexer</span> <span class="o">=</span> <span class="n">LEXERMAP</span><span class="p">[</span><span class="n">dialect</span><span class="p">]()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">HtmlFormatter</span><span class="p">()</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">ddl</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
            <span class="n">css</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">get_style_defs</span><span class="p">(</span><span class="s1">&#39;.highlight&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;introspect_file.mako&quot;</span><span class="p">,</span>
                                      <span class="nb">dict</span><span class="p">(</span><span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span>
                                           <span class="n">code_html</span><span class="o">=</span><span class="n">html</span><span class="p">),</span>
                                      <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">current_dialect</span> <span class="o">=</span> <span class="n">get_dialect_name</span><span class="p">(</span><span class="n">get_engine_from_session</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">))</span>
    <span class="n">current_dialect_description</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">DIALECT_CHOICES</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">current_dialect</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;view_ddl_choose_dialect.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">current_dialect</span><span class="o">=</span><span class="n">current_dialect</span><span class="p">,</span>
             <span class="n">current_dialect_description</span><span class="o">=</span><span class="n">current_dialect_description</span><span class="p">,</span>
             <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># View audit trail</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_AUDIT_TRAIL</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_audit_trail</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AuditTrailForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">REMOTE_IP_ADDR</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TRUNCATE</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
            <span class="n">querydict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Send the user to the actual data using GET:</span>
            <span class="c1"># (the parameters are NOT sensitive)</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_AUDIT_TRAIL</span><span class="p">,</span>
                                          <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;audit_trail_choices.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="n">AUDIT_TRUNCATE_AT</span> <span class="o">=</span> <span class="mi">100</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_AUDIT_TRAIL</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_audit_trail</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">)</span>
    <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REMOTE_IP_ADDR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">truncate</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_bool_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TRUNCATE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>

    <span class="k">def</span> <span class="nf">add_condition</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">AuditEntry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">when_access_utc</span> <span class="o">&gt;=</span> <span class="n">start_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span> <span class="n">start_datetime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">when_access_utc</span> <span class="o">&lt;=</span> <span class="n">end_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remote_addr</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">==</span> <span class="n">remote_addr</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">REMOTE_IP_ADDR</span><span class="p">,</span> <span class="n">remote_addr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
        <span class="c1"># https://stackoverflow.com/questions/8561470/sqlalchemy-filtering-by-relationship-attribute  # noqa</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">server_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">server_pk</span> <span class="o">==</span> <span class="n">server_pk</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">AuditEntry</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="c1"># audit_entries = dbsession.execute(q).fetchall()</span>
    <span class="c1"># ... no! That executes to give you row-type results.</span>
    <span class="c1"># audit_entries = q.all()</span>
    <span class="c1"># ... yes! But let&#39;s paginate, too:</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                             <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                             <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                             <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;audit_trail_view.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">),</span>
                                   <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                                   <span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">,</span>
                                   <span class="n">truncate_at</span><span class="o">=</span><span class="n">AUDIT_TRUNCATE_AT</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># View HL7 message log</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_HL7_MESSAGE_LOG</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_hl7_message_log</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">HL7MessageLogForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
            <span class="n">querydict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Send the user to the actual data using GET</span>
            <span class="c1"># (the parameters are NOT sensitive)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_MESSAGE_LOG</span><span class="p">,</span>
                                           <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;hl7_message_log_choices.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_MESSAGE_LOG</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_hl7_message_log</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">hl7_run_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">)</span>
    <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>

    <span class="k">def</span> <span class="nf">add_condition</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">HL7Message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">basetable</span> <span class="o">==</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">server_pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">serverpk</span> <span class="o">==</span> <span class="n">server_pk</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hl7_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">hl7_run_id</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span> <span class="n">hl7_run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">sent_at_utc</span> <span class="o">&gt;=</span> <span class="n">start_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span> <span class="n">start_datetime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">sent_at_utc</span> <span class="o">&lt;=</span> <span class="n">end_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">msg_id</span><span class="p">))</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                             <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                             <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                             <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;hl7_message_log_view.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">),</span>
                                   <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_MESSAGE</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_hl7_message</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">hl7_msg_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_MSG_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">hl7msg</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">HL7Message</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Message</span><span class="o">.</span><span class="n">msg_id</span> <span class="o">==</span> <span class="n">hl7_msg_id</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hl7msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad HL7 message ID </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hl7_msg_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;hl7_message_view.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">hl7msg</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># View HL7 run log and individual runs</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_HL7_RUN_LOG</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_hl7_run_log</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">HL7RunLogForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">,</span>
                <span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">querydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
            <span class="n">querydict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Send the user to the actual data using GET</span>
            <span class="c1"># (the parameters are NOT sensitive)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_RUN_LOG</span><span class="p">,</span>
                                           <span class="n">_query</span><span class="o">=</span><span class="n">querydict</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;hl7_run_log_choices.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_RUN_LOG</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_hl7_run_log</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">hl7_run_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">START_DATETIME</span><span class="p">)</span>
    <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_datetime_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">END_DATETIME</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>

    <span class="k">def</span> <span class="nf">add_condition</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">HL7Run</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hl7_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Run</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">hl7_run_id</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="s2">&quot;hl7_run_id&quot;</span><span class="p">,</span> <span class="n">hl7_run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Run</span><span class="o">.</span><span class="n">start_at_utc</span> <span class="o">&gt;=</span> <span class="n">start_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="s2">&quot;start_datetime&quot;</span><span class="p">,</span> <span class="n">start_datetime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Run</span><span class="o">.</span><span class="n">start_at_utc</span> <span class="o">&lt;=</span> <span class="n">end_datetime</span><span class="p">)</span>
        <span class="n">add_condition</span><span class="p">(</span><span class="s2">&quot;end_datetime&quot;</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">HL7Run</span><span class="o">.</span><span class="n">run_id</span><span class="p">))</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                             <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                             <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                             <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;hl7_run_log_view.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">),</span>
                                   <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_RUN</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_hl7_run</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">hl7_run_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_RUN_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">hl7run</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">HL7Run</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">HL7Run</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">hl7_run_id</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hl7run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad HL7 run ID </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hl7_run_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;hl7_run_view.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">hl7run</span><span class="o">=</span><span class="n">hl7run</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># User/server info views</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_OWN_USER_INFO</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;view_own_user_info.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_own_user_info</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">groups_page</span> <span class="o">=</span> <span class="n">CamcopsPage</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
                              <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">groups_page</span><span class="o">=</span><span class="n">groups_page</span><span class="p">)</span>


<div class="viewcode-block" id="view_server_info"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.view_server_info">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_SERVER_INFO</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;view_server_info.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_server_info</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HTML showing server&#39;s ID policies, etc..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">idnum_definitions</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">idnum_definitions</span><span class="p">,</span>
        <span class="n">string_families</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">extrastring_families</span><span class="p">(),</span>
        <span class="n">all_task_classes</span><span class="o">=</span><span class="n">Task</span><span class="o">.</span><span class="n">all_subclasses_by_longname</span><span class="p">(),</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># User management</span>
<span class="c1"># =============================================================================</span>

<span class="n">EDIT_USER_KEYS_GROUPADMIN</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># SPECIAL HANDLING # ViewParam.USER_ID,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">FULLNAME</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">EMAIL</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MUST_CHANGE_PASSWORD</span><span class="p">,</span>
    <span class="c1"># SPECIAL HANDLING # ViewParam.GROUP_IDS,</span>
<span class="p">]</span>
<span class="n">EDIT_USER_KEYS_SUPERUSER</span> <span class="o">=</span> <span class="n">EDIT_USER_KEYS_GROUPADMIN</span> <span class="o">+</span> <span class="p">[</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">EDIT_USER_GROUP_MEMBERSHIP_KEYS_GROUPADMIN</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_UPLOAD</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_REGISTER_DEVICES</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_USE_WEBVIEWER</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEW_ALL_PATIENTS_WHEN_UNFILTERED</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_DUMP_DATA</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_RUN_REPORTS</span><span class="p">,</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">MAY_ADD_NOTES</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">EDIT_USER_GROUP_MEMBERSHIP_KEYS_SUPERUSER</span> <span class="o">=</span> <span class="n">EDIT_USER_GROUP_MEMBERSHIP_KEYS_GROUPADMIN</span> <span class="o">+</span> <span class="p">[</span>  <span class="c1"># noqa</span>
    <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such user ID: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;users_view.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_all_users</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="c1"># LOGIC SHOULD MATCH assert_may_edit_user</span>
        <span class="c1"># Restrict to users who are members of groups that I am an admin for:</span>
        <span class="n">groupadmin_group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span>
        <span class="n">ugm2</span> <span class="o">=</span> <span class="n">UserGroupMembership</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ugm2&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_group_memberships</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">not_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">superuser</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UserGroupMembership</span><span class="o">.</span><span class="n">group_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">groupadmin_group_ids</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="o">~</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">ugm2</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">and_</span><span class="p">(</span>
                        <span class="n">ugm2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">ugm2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">groupadmin</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># ... no superusers</span>
        <span class="c1"># ... user must be a member of one of our groups</span>
        <span class="c1"># ... no groupadmins</span>
        <span class="c1"># https://stackoverflow.com/questions/14600619/using-not-exists-clause-in-sqlalchemy-orm-query  # noqa</span>
        <span class="c1"># log.critical(str(q))</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                             <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                             <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                             <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                <span class="n">as_superuser</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">)</span>


<div class="viewcode-block" id="assert_may_edit_user"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.assert_may_edit_user">[docs]</a><span class="k">def</span> <span class="nf">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks that the requesting user (req.user) is allowed to edit the other</span>
<span class="sd">    user (user). Raises HTTPBadRequest otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># LOGIC SHOULD MATCH view_all_users</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Nobody may edit the system user&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;You may not edit a superuser&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_a_groupadmin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;You may not edit a group administrator&quot;</span><span class="p">)</span>
        <span class="n">groupadmin_group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">gid</span> <span class="ow">in</span> <span class="n">groupadmin_group_ids</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">group_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;You are not a group administrator for any &quot;</span>
                                 <span class="s2">&quot;groups that this user is in&quot;</span><span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_USER</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;view_other_user_info.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Groupadmins may see some information regarding groups that aren&#39;t theirs</span>
    <span class="c1"># here, but can&#39;t alter it.</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_USER</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;user_edit.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="c1"># Superusers can do everything, of course.</span>
    <span class="c1"># Groupadmins can change group memberships only for groups they control</span>
    <span class="c1"># (here: &quot;fluid&quot;). That means that there may be a subset of group</span>
    <span class="c1"># memberships for this user that they will neither see nor be able to</span>
    <span class="c1"># alter (here: &quot;frozen&quot;). They can also edit only a restricted set of</span>
    <span class="c1"># permissions.</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditUserFullForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">EDIT_USER_KEYS_SUPERUSER</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditUserGroupAdminForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">EDIT_USER_KEYS_GROUPADMIN</span>
    <span class="c1"># Groups that we might change memberships for:</span>
    <span class="n">all_fluid_groups</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span>
    <span class="c1"># All groups that the user is currently in:</span>
    <span class="n">user_group_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">group_ids</span>
    <span class="c1"># Group membership we won&#39;t touch:</span>
    <span class="n">user_frozen_group_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_group_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_fluid_groups</span><span class="p">))</span>
    <span class="c1"># Group memberships we might alter:</span>
    <span class="n">user_fluid_group_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_group_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_fluid_groups</span><span class="p">))</span>
    <span class="c1"># log.critical(</span>
    <span class="c1">#     &quot;all_fluid_groups={}, user_group_ids={}, &quot;</span>
    <span class="c1">#     &quot;user_frozen_group_ids={}, user_fluid_group_ids={}&quot;.format(</span>
    <span class="c1">#         all_fluid_groups, user_group_ids,</span>
    <span class="c1">#         user_frozen_group_ids, user_fluid_group_ids)</span>
    <span class="c1"># )</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply the edits</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
            <span class="n">new_user_name</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">)</span>
            <span class="n">existing_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_name</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">new_user_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_user</span> <span class="ow">and</span> <span class="n">existing_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t rename user </span><span class="si">{!r}</span><span class="s2"> (ID </span><span class="si">{!r}</span><span class="s2">) to </span><span class="si">{!r}</span><span class="s2">; that &quot;</span>
                    <span class="s2">&quot;conflicts with existing user with ID </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_user_name</span><span class="p">,</span>
                        <span class="n">existing_user</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">group_ids</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>
            <span class="c1"># Add back in the groups we&#39;re not going to alter:</span>
            <span class="n">final_group_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_frozen_group_ids</span><span class="p">))</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_group_ids</span><span class="p">(</span><span class="n">final_group_ids</span><span class="p">)</span>
            <span class="c1"># Also, if the user was uploading to a group that they are now no</span>
            <span class="c1"># longer a member of, we need to fix that</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_group_ids</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">appstruct</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="n">appstruct</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_fluid_group_ids</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_USER_GROUP_MEMBERSHIP</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;user_edit_group_membership.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_user_group_membership</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">ugm_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_GROUP_MEMBERSHIP_ID</span><span class="p">)</span>
    <span class="n">ugm</span> <span class="o">=</span> <span class="n">UserGroupMembership</span><span class="o">.</span><span class="n">get_ugm_by_id</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">ugm_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ugm</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such UserGroupMembership ID: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">ugm_id</span><span class="p">)))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">ugm</span><span class="o">.</span><span class="n">user</span>
    <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditUserGroupMembershipFullForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">EDIT_USER_GROUP_MEMBERSHIP_KEYS_SUPERUSER</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">EditUserGroupMembershipGroupAdminForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">EDIT_USER_GROUP_MEMBERSHIP_KEYS_GROUPADMIN</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply the changes</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">ugm</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ugm</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ugm</span><span class="o">=</span><span class="n">ugm</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">set_user_upload_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span>
                          <span class="n">as_superuser</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span> <span class="k">if</span> <span class="n">as_superuser</span> <span class="k">else</span> <span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">SetUserUploadGroupForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># ... need to show the groups permitted to THAT user, not OUR user</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply the changes</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">UPLOAD_GROUP_ID</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">UPLOAD_GROUP_ID</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span>
        <span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;set_user_upload_group.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
             <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_OWN_USER_UPLOAD_GROUP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_own_user_upload_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">set_user_upload_group</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_OTHER_USER_UPLOAD_GROUP</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_other_user_upload_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">set_user_upload_group</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">UNLOCK_USER</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unlock_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;User </span><span class="si">{}</span><span class="s2"> enabled&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_USER</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;user_add.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AddUserSuperuserForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AddUserGroupadminForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Add the user</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USERNAME</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NEW_PASSWORD</span><span class="p">))</span>
            <span class="n">user</span><span class="o">.</span><span class="n">must_change_password</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">MUST_CHANGE_PASSWORD</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_name</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;User with username </span><span class="si">{!r}</span><span class="s2"> already &quot;</span>
                                     <span class="s2">&quot;exists!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
            <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">group_ids</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">user_group_memberships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserGroupMembership</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">group_id</span><span class="o">=</span><span class="n">gid</span>
                <span class="p">))</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">any_records_use_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># Device?</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">CountStarSpecializedQuery</span><span class="p">(</span><span class="n">Device</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">dbsession</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">registered_by_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="n">Device</span><span class="o">.</span><span class="n">uploading_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count_star</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># SpecialNote?</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">CountStarSpecializedQuery</span><span class="p">(</span><span class="n">SpecialNote</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">dbsession</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count_star</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># Uploaded records?</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">gen_orm_classes_from_base</span><span class="p">(</span><span class="n">GenericTabletRecordMixin</span><span class="p">):</span>  <span class="c1"># type: Type[GenericTabletRecordMixin]  # noqa</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">CountStarSpecializedQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">dbsession</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_adding_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_removing_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_preserving_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_manually_erasing_user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count_star</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># No; all clean.</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;user_delete.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_from_request_user_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">assert_may_edit_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteUserForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">rendered_form</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t delete your own user!&quot;</span>
    <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">may_use_webviewer</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">may_upload</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete user: user still has webviewer login &quot;</span> \
                <span class="s2">&quot;and/or tablet upload permission&quot;</span>
    <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">group_ids</span><span class="p">)</span> <span class="o">-</span>
                 <span class="nb">set</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span><span class="p">))):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete user: user belongs to groups that you do &quot;</span> \
                <span class="s2">&quot;not administer&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">any_records_use_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete user; records refer to that user. &quot;</span> \
                    <span class="s2">&quot;Disable login and upload permissions instead.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                    <span class="c1"># ---------------------------------------------------------</span>
                    <span class="c1"># Delete the user and associated objects</span>
                    <span class="c1"># ---------------------------------------------------------</span>
                    <span class="c1"># (*) Sessions belonging to this user</span>
                    <span class="c1"># ... done by modifying its ForeignKey to use &quot;ondelete&quot;</span>
                    <span class="c1"># (*) user_group_table mapping</span>
                    <span class="c1"># http://docs.sqlalchemy.org/en/latest/orm/basic_relationships.html#relationships-many-to-many-deletion  # noqa</span>
                    <span class="c1"># Simplest way:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># will delete the mapping entries</span>
                    <span class="c1"># (*) User itself</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="c1"># Done</span>
                    <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">USER_ID</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
                <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Group management</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_GROUPS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;groups_view.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_groups</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">rows_per_page</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ROWS_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">)</span>
    <span class="n">page_num</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                             <span class="n">page</span><span class="o">=</span><span class="n">page_num</span><span class="p">,</span>
                             <span class="n">items_per_page</span><span class="o">=</span><span class="n">rows_per_page</span><span class="p">,</span>
                             <span class="n">url_maker</span><span class="o">=</span><span class="n">PageUrl</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">groups_page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_group_from_request_group_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Group</span><span class="p">:</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such group ID: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">group_id</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">group</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_GROUP</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;group_edit.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_GROUPS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">get_group_from_request_group_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EditGroupForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply the changes</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Simple attributes</span>
            <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">upload_policy</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">UPLOAD_POLICY</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">finalize_policy</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">FINALIZE_POLICY</span><span class="p">)</span>
            <span class="c1"># Group cross-references</span>
            <span class="n">group_ids</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">)</span>
            <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">group_ids</span> <span class="k">if</span> <span class="n">gid</span> <span class="o">!=</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="c1"># ... don&#39;t bother saying &quot;you can see yourself&quot;</span>
            <span class="n">other_groups</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">get_groups_from_id_list</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">can_see_other_groups</span> <span class="o">=</span> <span class="n">other_groups</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">other_group_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">ids_of_other_groups_group_may_see</span><span class="p">())</span>
        <span class="n">other_groups</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">get_groups_from_id_list</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">other_group_ids</span><span class="p">)</span>
        <span class="n">other_groups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">UPLOAD_POLICY</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">upload_policy</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">FINALIZE_POLICY</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">finalize_policy</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_IDS</span><span class="p">:</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">other_groups</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_GROUP</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;group_add.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_GROUPS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AddGroupForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Add the group</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">()</span>
            <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
            <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">any_records_use_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># Our own or users filtering on us?</span>
    <span class="c1"># ... doesn&#39;t matter; see TaskFilter; stored as a CSV list so not part of</span>
    <span class="c1">#     database integrity checks.</span>
    <span class="c1"># Uploaded records?</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">gen_orm_classes_from_base</span><span class="p">(</span><span class="n">GenericTabletRecordMixin</span><span class="p">):</span>  <span class="c1"># type: Type[GenericTabletRecordMixin]  # noqa</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">CountStarSpecializedQuery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">dbsession</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_group_id</span> <span class="o">==</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count_star</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># No; all clean.</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_GROUP</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;group_delete.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_group</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_GROUPS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">get_group_from_request_group_id_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteGroupForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">rendered_form</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete group; there are users who are members!&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">any_records_use_group</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete group; records refer to it.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">)</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span>
                    <span class="c1"># ---------------------------------------------------------</span>
                    <span class="c1"># Delete the group</span>
                    <span class="c1"># ---------------------------------------------------------</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
                <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Edit server settings</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_SERVER_SETTINGS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;server_settings_edit.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_server_settings</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EditServerSettingsForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DATABASE_TITLE</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply changes</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">req</span><span class="o">.</span><span class="n">set_database_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">database_title</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DATABASE_TITLE</span><span class="p">:</span> <span class="n">title</span><span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ID_DEFINITIONS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;id_definitions_view.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_id_definitions</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">idnum_definitions</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">idnum_definitions</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_iddef_from_request_which_idnum_or_raise</span><span class="p">(</span>
        <span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdNumDefinition</span><span class="p">:</span>
    <span class="n">which_idnum</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">)</span>
    <span class="n">iddef</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">IdNumDefinition</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">IdNumDefinition</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">==</span> <span class="n">which_idnum</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iddef</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such ID definition: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">which_idnum</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">iddef</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_ID_DEFINITION</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;id_definition_edit.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_id_definition</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ID_DEFINITIONS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">iddef</span> <span class="o">=</span> <span class="n">get_iddef_from_request_which_idnum_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EditIdDefinitionForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Alter the ID definition</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">iddef</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">)</span>
            <span class="n">iddef</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SHORT_DESCRIPTION</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="n">iddef</span><span class="o">.</span><span class="n">hl7_id_type</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_ID_TYPE</span><span class="p">)</span>
            <span class="n">iddef</span><span class="o">.</span><span class="n">hl7_assigning_authority</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_ASSIGNING_AUTHORITY</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="c1"># REMOVED # clear_idnum_definition_cache()  # SPECIAL</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SHORT_DESCRIPTION</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">short_description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_ID_TYPE</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">hl7_id_type</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">HL7_ASSIGNING_AUTHORITY</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">hl7_assigning_authority</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">iddef</span><span class="o">=</span><span class="n">iddef</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_ID_DEFINITION</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;id_definition_add.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_id_definition</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ID_DEFINITIONS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AddIdDefinitionForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">iddef</span> <span class="o">=</span> <span class="n">IdNumDefinition</span><span class="p">(</span>
                <span class="n">which_idnum</span><span class="o">=</span><span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">),</span>
                <span class="n">description</span><span class="o">=</span><span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">),</span>
                <span class="n">short_description</span><span class="o">=</span><span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SHORT_DESCRIPTION</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Add ID definition</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iddef</span><span class="p">)</span>
            <span class="c1"># REMOVED # clear_idnum_definition_cache()  # SPECIAL</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">any_records_use_iddef</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">iddef</span><span class="p">:</span> <span class="n">IdNumDefinition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># Helpfully, these are only referred to permanently from one place:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">CountStarSpecializedQuery</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">==</span> <span class="n">iddef</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">count_star</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># No; all clean.</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_ID_DEFINITION</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;id_definition_delete.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_id_definition</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">route_back</span> <span class="o">=</span> <span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ID_DEFINITIONS</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
    <span class="n">iddef</span> <span class="o">=</span> <span class="n">get_iddef_from_request_which_idnum_or_raise</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteIdDefinitionForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">rendered_form</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">any_records_use_iddef</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">iddef</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Unable to delete ID definition; records refer to it.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">)</span> <span class="o">==</span> <span class="n">iddef</span><span class="o">.</span><span class="n">which_idnum</span>  <span class="c1"># noqa</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="c1"># Delete ID definition</span>
                <span class="c1"># -------------------------------------------------------------</span>
                <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">iddef</span><span class="p">)</span>
                <span class="c1"># REMOVED # clear_idnum_definition_cache()  # SPECIAL</span>
                <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_back</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">:</span> <span class="n">iddef</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">}</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">iddef</span><span class="o">=</span><span class="n">iddef</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Introspection of source code</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="offer_introspection"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.offer_introspection">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_INTROSPECTION</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">offer_introspection</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Page to offer CamCOPS server source code.&quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">introspection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simple_failure</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">NO_INTROSPECTION_MSG</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;introspection_file_list.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">ifd_list</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">introspection_files</span><span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="introspect"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.introspect">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">INTROSPECT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">introspect</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provide formatted source code.&quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">introspection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simple_failure</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">NO_INTROSPECTION_MSG</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ifd</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ifd</span> <span class="k">for</span> <span class="n">ifd</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">introspection_files</span>
                   <span class="k">if</span> <span class="n">ifd</span><span class="o">.</span><span class="n">prettypath</span> <span class="o">==</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simple_failure</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">INTROSPECTION_INVALID_FILE_MSG</span><span class="p">)</span>
    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">fullpath</span>

    <span class="k">if</span> <span class="n">fullpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsx&quot;</span><span class="p">):</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">JavascriptLexer</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">get_lexer_for_filename</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">HtmlFormatter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;INTROSPECTION ERROR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">simple_failure</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">INTROSPECTION_FAILED_MSG</span><span class="p">)</span>
    <span class="n">code_html</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
    <span class="n">css</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">get_style_defs</span><span class="p">(</span><span class="s1">&#39;.highlight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s2">&quot;introspect_file.mako&quot;</span><span class="p">,</span>
                              <span class="nb">dict</span><span class="p">(</span><span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span>
                                   <span class="n">code_html</span><span class="o">=</span><span class="n">code_html</span><span class="p">),</span>
                              <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Altering data. Some of the more complex logic is here.</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="add_special_note"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.add_special_note">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_SPECIAL_NOTE</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;special_note_add.mako&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_special_note</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a special note to a task (after confirmation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">)</span>
    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">url_back</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span>
        <span class="n">Routes</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span>
        <span class="n">_query</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">:</span> <span class="n">server_pk</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEWTYPE</span><span class="p">:</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">url_back</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">task_factory</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such task: </span><span class="si">{}</span><span class="s2">, PK=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table_name</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">authorized_to_add_special_note</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_group_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Not authorized to add special notes for this &quot;</span>
                             <span class="s2">&quot;task&#39;s group&quot;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AddSpecialNoteForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">note</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">NOTE</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply special note</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">task</span><span class="o">.</span><span class="n">apply_special_note</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">url_back</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">:</span> <span class="n">server_pk</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">]))</span></div>


<div class="viewcode-block" id="erase_task"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.erase_task">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">ERASE_TASK</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erase_task</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wipe all data from a task (after confirmation).</span>

<span class="sd">    Leaves the task record as a placeholder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">)</span>
    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">url_back</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span>
        <span class="n">Routes</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span>
        <span class="n">_query</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">:</span> <span class="n">server_pk</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">VIEWTYPE</span><span class="p">:</span> <span class="n">ViewArg</span><span class="o">.</span><span class="n">HTML</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">url_back</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">task_factory</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such task: </span><span class="si">{}</span><span class="s2">, PK=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table_name</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">is_erased</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Task already erased&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">is_live_on_tablet</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">ERROR_TASK_LIVE</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">authorized_to_erase_tasks</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_group_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Not authorized to erase tasks for this &quot;</span>
                             <span class="s2">&quot;task&#39;s group&quot;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EraseTaskForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Erase task</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">task</span><span class="o">.</span><span class="n">manually_erase</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span>
                <span class="s2">&quot;Task erased (</span><span class="si">{t}</span><span class="s2">, server PK </span><span class="si">{pk}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                                                            <span class="n">pk</span><span class="o">=</span><span class="n">server_pk</span><span class="p">),</span>
                <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{url}</span><span class="s1">&quot;&gt;View amended task&lt;/a&gt;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url_back</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">TABLE_NAME</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
            <span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">:</span> <span class="n">server_pk</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;task_erase.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="delete_patient"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.delete_patient">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_PATIENT</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_patient</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Completely delete all data from a patient (after confirmation),</span>
<span class="sd">    within a specific group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>

    <span class="n">first_form</span> <span class="o">=</span> <span class="n">DeletePatientChooseForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">second_form</span> <span class="o">=</span> <span class="n">DeletePatientConfirmForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">final_phase</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="c1"># FIRST form has been submitted</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">first_form</span>
    <span class="k">elif</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="c1"># SECOND AND FINAL form has been submitted</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">second_form</span>
        <span class="n">final_phase</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="n">which_idnum</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">)</span>
            <span class="n">idnum_value</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">)</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span><span class="p">:</span>
                <span class="c1"># rare occurrence; form should prevent it;</span>
                <span class="c1"># unless superuser has changed status since form was read</span>
                <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;You&#39;re not an admin for this group&quot;</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Fetch tasks to be deleted.</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
            <span class="c1"># Tasks first:</span>
            <span class="n">idnum_ref</span> <span class="o">=</span> <span class="n">IdNumReference</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="n">which_idnum</span><span class="p">,</span>
                                       <span class="n">idnum_value</span><span class="o">=</span><span class="n">idnum_value</span><span class="p">)</span>
            <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
            <span class="n">taskfilter</span><span class="o">.</span><span class="n">idnum_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">idnum_ref</span><span class="p">]</span>
            <span class="n">taskfilter</span><span class="o">.</span><span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_id</span><span class="p">]</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
                <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
                <span class="n">sort_method_global</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_DESC</span><span class="p">,</span>
                <span class="n">current_only</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># unusual option!</span>
            <span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">all_tasks</span>
            <span class="n">n_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="n">patient_lineage_instances</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">get_patients_by_idnum</span><span class="p">(</span>
                <span class="n">dbsession</span><span class="o">=</span><span class="n">dbsession</span><span class="p">,</span>
                <span class="n">which_idnum</span><span class="o">=</span><span class="n">which_idnum</span><span class="p">,</span>
                <span class="n">idnum_value</span><span class="o">=</span><span class="n">idnum_value</span><span class="p">,</span>
                <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                <span class="n">current_only</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">n_patient_instances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patient_lineage_instances</span><span class="p">)</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Bin out at this stage and offer confirmation page?</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase</span><span class="p">:</span>
                <span class="c1"># New appstruct; we don&#39;t want the validation code persisting</span>
                <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">:</span> <span class="n">which_idnum</span><span class="p">,</span>
                    <span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">:</span> <span class="n">idnum_value</span><span class="p">,</span>
                    <span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">second_form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
                    <span class="s2">&quot;patient_delete_confirm.mako&quot;</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
                        <span class="n">n_patient_instances</span><span class="o">=</span><span class="n">n_patient_instances</span><span class="p">,</span>
                        <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
                    <span class="p">),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">req</span>
                <span class="p">)</span>

            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Delete patient and associated tasks</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">delete_entirely</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="c1"># Then patients:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patient_lineage_instances</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">delete_with_dependants</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Patient with idnum</span><span class="si">{wi}</span><span class="s2"> = </span><span class="si">{iv}</span><span class="s2"> and associated tasks DELETED &quot;</span>
                <span class="s2">&quot;from group </span><span class="si">{g}</span><span class="s2">. Deleted </span><span class="si">{nt}</span><span class="s2"> task records and </span><span class="si">{np}</span><span class="s2"> patient &quot;</span>
                <span class="s2">&quot;records (current and/or old).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wi</span><span class="o">=</span><span class="n">which_idnum</span><span class="p">,</span>
                    <span class="n">iv</span><span class="o">=</span><span class="n">idnum_value</span><span class="p">,</span>
                    <span class="n">g</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                    <span class="n">nt</span><span class="o">=</span><span class="n">n_tasks</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">=</span><span class="n">n_patient_instances</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">first_form</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">first_form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;patient_delete_choose.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_PATIENT</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_patient</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>

    <span class="n">server_pk</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_int_param</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">get_patient_by_pk</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">server_pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such patient&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Bad patient: not in a group&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">user_may_edit</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;Not authorized to edit this patient&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">is_editable</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span>
            <span class="s2">&quot;Patient is not editable (likely: not finalized, so a copy is &quot;</span>
            <span class="s2">&quot;still on a client device&quot;</span><span class="p">)</span>

    <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">patient</span><span class="o">.</span><span class="n">get_device_id</span><span class="p">()]</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">patient</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
    <span class="n">taskfilter</span><span class="o">.</span><span class="n">era</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_era</span><span class="p">()</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
        <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
        <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
        <span class="n">sort_method_global</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_DESC</span><span class="p">,</span>
        <span class="n">current_only</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># unusual option!</span>
    <span class="p">)</span>
    <span class="n">affected_tasks</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">all_tasks</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">EditPatientForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Apply edits</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Calculate the changes, and apply them to the Patient object</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># type: Dict[str, Tuple[Any, Any]]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">EDIT_PATIENT_SIMPLE_PARAMS</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">FORENAME</span><span class="p">,</span> <span class="n">ViewParam</span><span class="o">.</span><span class="n">SURNAME</span><span class="p">]:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="n">old_value</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">new_value</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">old_value</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
                    <span class="c1"># Nothing really changing!</span>
                    <span class="k">continue</span>
                <span class="n">changes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
            <span class="c1"># The ID numbers are more complex.</span>
            <span class="c1"># log.critical(&quot;{}&quot;, pformat(appstruct))</span>
            <span class="n">new_idrefs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">IdNumReference</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="n">idrefdict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">],</span>
                               <span class="n">idnum_value</span><span class="o">=</span><span class="n">idrefdict</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idrefdict</span> <span class="ow">in</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ID_REFERENCES</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">idnum</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">idnums</span><span class="p">:</span>
                <span class="n">matching_idref</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">idref</span> <span class="k">for</span> <span class="n">idref</span> <span class="ow">in</span> <span class="n">new_idrefs</span>
                     <span class="k">if</span> <span class="n">idref</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">==</span> <span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_idref</span><span class="p">:</span>
                    <span class="c1"># Delete ID numbers not present in the new set</span>
                    <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;idnum</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">get_id_desc</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">))</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">idnum</span><span class="o">.</span><span class="n">mark_as_deleted</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">matching_idref</span><span class="o">.</span><span class="n">idnum_value</span> <span class="o">!=</span> <span class="n">idnum</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">:</span>
                    <span class="c1"># Modify altered ID numbers present in the old + new sets</span>
                    <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;idnum</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">get_id_desc</span><span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">))</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">idnum</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">,</span> <span class="n">matching_idref</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">)</span>
                    <span class="n">new_idnum</span> <span class="o">=</span> <span class="n">PatientIdNum</span><span class="p">()</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">idnum</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="n">idnum</span><span class="o">.</span><span class="n">patient_id</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">=</span> <span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">idnum_value</span> <span class="o">=</span> <span class="n">matching_idref</span><span class="o">.</span><span class="n">idnum_value</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">set_predecessor</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">idnum</span><span class="p">)</span>
            <span class="n">max_existing_pidnum_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">idref</span> <span class="ow">in</span> <span class="n">new_idrefs</span><span class="p">:</span>
                <span class="n">matching_idnum</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">idnum</span> <span class="k">for</span> <span class="n">idnum</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">idnums</span>
                     <span class="k">if</span> <span class="n">idnum</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">==</span> <span class="n">idref</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_idnum</span><span class="p">:</span>
                    <span class="c1"># Create ID numbers where they were absent</span>
                    <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;idnum</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">idref</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">get_id_desc</span><span class="p">(</span><span class="n">idref</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">))</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">)</span>
                    <span class="c1"># We need to establish an &quot;id&quot; field, which is the PK as</span>
                    <span class="c1"># seen by the tablet. The tablet has lost interest in these</span>
                    <span class="c1"># records, since _era != ERA_NOW, so all we have to do is</span>
                    <span class="c1"># pick a number that&#39;s not in use.</span>
                    <span class="k">if</span> <span class="n">max_existing_pidnum_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># noinspection PyProtectedMember</span>
                        <span class="n">max_existing_pidnum_id</span> <span class="o">=</span> <span class="n">dbsession</span>\
                            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span>
                                    <span class="n">patient</span><span class="o">.</span><span class="n">get_device_id</span><span class="p">())</span>\
                            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">patient</span><span class="o">.</span><span class="n">get_era</span><span class="p">())</span>\
                            <span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">max_existing_pidnum_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">max_existing_pidnum_id</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># so start at 1</span>
                    <span class="n">new_idnum</span> <span class="o">=</span> <span class="n">PatientIdNum</span><span class="p">()</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">max_existing_pidnum_id</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">max_existing_pidnum_id</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">which_idnum</span> <span class="o">=</span> <span class="n">idref</span><span class="o">.</span><span class="n">which_idnum</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">idnum_value</span> <span class="o">=</span> <span class="n">idref</span><span class="o">.</span><span class="n">idnum_value</span>
                    <span class="n">new_idnum</span><span class="o">.</span><span class="n">create_fresh</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
                                           <span class="n">device_id</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">get_device_id</span><span class="p">(),</span>
                                           <span class="n">era</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">get_era</span><span class="p">(),</span>
                                           <span class="n">group_id</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">get_group_id</span><span class="p">())</span>
                    <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_idnum</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">changes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span>
                    <span class="n">req</span><span class="p">,</span>
                    <span class="s2">&quot;No changes required for patient record with server PK </span><span class="si">{}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;(all new values matched old values)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_pk</span><span class="p">))</span>

            <span class="c1"># Below here, changes have definitely been made.</span>
            <span class="n">change_msg</span> <span class="o">=</span> <span class="s2">&quot;Patient details edited. Changes: &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{k}</span><span class="s2">: </span><span class="si">{old!r}</span><span class="s2">  </span><span class="si">{new!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># Apply special note to patient</span>
            <span class="n">patient</span><span class="o">.</span><span class="n">apply_special_note</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">change_msg</span><span class="p">,</span> <span class="s2">&quot;Patient edited&quot;</span><span class="p">)</span>

            <span class="c1"># Patient details changed, so resend any tasks via HL7</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">affected_tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">delete_from_hl7_message_log</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># Done</span>
            <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span>
                <span class="n">req</span><span class="p">,</span>
                <span class="s2">&quot;Amended patient record with server PK </span><span class="si">{}</span><span class="s2">. Changes were: &quot;</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_pk</span><span class="p">,</span> <span class="n">change_msg</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">EDIT_PATIENT_SIMPLE_PARAMS</span><span class="p">}</span>
        <span class="n">appstruct</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">SERVER_PK</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_pk</span>
        <span class="n">appstruct</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">GROUP_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">id</span>
        <span class="n">appstruct</span><span class="p">[</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">ID_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">WHICH_IDNUM</span><span class="p">:</span> <span class="n">pidnum</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">,</span>
             <span class="n">ViewParam</span><span class="o">.</span><span class="n">IDNUM_VALUE</span><span class="p">:</span> <span class="n">pidnum</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">pidnum</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">idnums</span>
        <span class="p">]</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;patient_edit.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">,</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
            <span class="n">tasks</span><span class="o">=</span><span class="n">affected_tasks</span><span class="p">,</span>
            <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span>


<div class="viewcode-block" id="forcibly_finalize"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.forcibly_finalize">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">FORCIBLY_FINALIZE</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">forcibly_finalize</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Force-finalize all live (_era == ERA_NOW) records from a device.</span>
<span class="sd">    Available to group administrators if all those records are within their</span>
<span class="sd">    groups (otherwise, it&#39;s a superuser operation).</span>

<span class="sd">    This is a superuser permission, since we can&#39;t guarantee to know what group</span>
<span class="sd">    the device relates to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">CANCEL</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">))</span>

    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">first_form</span> <span class="o">=</span> <span class="n">ForciblyFinalizeChooseDeviceForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">second_form</span> <span class="o">=</span> <span class="n">ForciblyFinalizeConfirmForm</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">final_phase</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">SUBMIT</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="c1"># FIRST form has been submitted</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">first_form</span>
    <span class="k">elif</span> <span class="n">FormAction</span><span class="o">.</span><span class="n">FINALIZE</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="c1"># SECOND form has been submitted:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">second_form</span>
        <span class="n">final_phase</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">appstruct</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span>
            <span class="c1"># log.critical(&quot;{}&quot;, pformat(appstruct))</span>
            <span class="n">device_id</span> <span class="o">=</span> <span class="n">appstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DEVICE_ID</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">Device</span><span class="o">.</span><span class="n">get_device_by_id</span><span class="p">(</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span><span class="s2">&quot;No such device: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device_id</span><span class="p">))</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># If at the first stage, bin out and offer confirmation page</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase</span><span class="p">:</span>
                <span class="n">appstruct</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewParam</span><span class="o">.</span><span class="n">DEVICE_ID</span><span class="p">:</span> <span class="n">device_id</span><span class="p">}</span>
                <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">second_form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
                <span class="n">taskfilter</span> <span class="o">=</span> <span class="n">TaskFilter</span><span class="p">()</span>
                <span class="n">taskfilter</span><span class="o">.</span><span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_id</span><span class="p">]</span>
                <span class="n">taskfilter</span><span class="o">.</span><span class="n">era</span> <span class="o">=</span> <span class="n">ERA_NOW</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="n">TaskCollection</span><span class="p">(</span>
                    <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                    <span class="n">taskfilter</span><span class="o">=</span><span class="n">taskfilter</span><span class="p">,</span>
                    <span class="n">sort_method_global</span><span class="o">=</span><span class="n">TaskSortMethod</span><span class="o">.</span><span class="n">CREATION_DATE_DESC</span><span class="p">,</span>
                    <span class="n">current_only</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># unusual option!</span>
                <span class="p">)</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">all_tasks</span>
                <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
                    <span class="s2">&quot;device_forcibly_finalize_confirm.mako&quot;</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
                         <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
                         <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">req</span>
                <span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Check it&#39;s permitted</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
                <span class="n">admin_group_ids</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids_of_groups_user_is_admin_for</span>
                <span class="k">for</span> <span class="n">clienttable</span> <span class="ow">in</span> <span class="n">CLIENT_TABLE_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="c1"># noinspection PyProtectedMember</span>
                    <span class="n">count_query</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()])</span>
                        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">clienttable</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clienttable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clienttable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clienttable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_group_id</span><span class="o">.</span><span class="n">notin_</span><span class="p">(</span><span class="n">admin_group_ids</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">count_query</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPBadRequest</span><span class="p">(</span>
                            <span class="s2">&quot;Some records for this device are in groups for &quot;</span>
                            <span class="s2">&quot;which you are not an administrator&quot;</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Forcibly finalize</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">new_era</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">now_iso8601_era_format</span>
            <span class="k">for</span> <span class="n">clienttable</span> <span class="ow">in</span> <span class="n">CLIENT_TABLE_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># noinspection PyProtectedMember</span>
                <span class="n">finalize_statement</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">clienttable</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clienttable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clienttable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_era</span><span class="o">=</span><span class="n">new_era</span><span class="p">,</span>
                            <span class="n">_preserving_user_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                            <span class="n">_forcibly_preserved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">finalize_statement</span><span class="p">)</span>
            <span class="c1"># Field names are different in server-side tables, so they need</span>
            <span class="c1"># special handling:</span>
            <span class="n">SpecialNote</span><span class="o">.</span><span class="n">forcibly_preserve_special_notes_for_device</span><span class="p">(</span><span class="n">req</span><span class="p">,</span>
                                                                   <span class="n">device_id</span><span class="p">)</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="c1"># Done</span>
            <span class="c1"># -----------------------------------------------------------------</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Live records for device </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) forcibly finalized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">device_id</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">)</span>
            <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">simple_success</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ValidationFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">first_form</span>
        <span class="n">rendered_form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>  <span class="c1"># no appstruct</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
        <span class="s2">&quot;device_forcibly_finalize_choose.mako&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">rendered_form</span><span class="p">,</span>
             <span class="n">head_form_html</span><span class="o">=</span><span class="n">get_head_form_html</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">[</span><span class="n">form</span><span class="p">])),</span>
        <span class="n">request</span><span class="o">=</span><span class="n">req</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Static assets</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/assets.html#advanced-static  # noqa</span>

<span class="n">DEFORM_MISSING_GLYPH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STATIC_ROOT_DIR</span><span class="p">,</span>
                                    <span class="s2">&quot;glyphicons-halflings-regular.woff2&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="static_bugfix_deform_missing_glyphs"><a class="viewcode-back" href="../../../autodoc/cc_modules/webview.html#camcops_server.cc_modules.webview.static_bugfix_deform_missing_glyphs">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">BUGFIX_DEFORM_MISSING_GLYPHS</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">static_bugfix_deform_missing_glyphs</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hack for a missing-file bug in deform==2.0.4:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">DEFORM_MISSING_GLYPH</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/creating_tasks.html">16. Creating tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/development_command_line.html">17. Development command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">18. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/linux_flavours.html">19. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/design_notes.html">20. Design notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/_index.html">21. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">22. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/known_problems.html">23. Known problems: client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/known_problems.html#known-problems-server">24. Known problems: server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/to_do.html">25. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/wishlist.html">26. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/local_info.html">27. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>